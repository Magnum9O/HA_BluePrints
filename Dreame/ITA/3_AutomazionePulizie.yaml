blueprint:
  name: "Dreame Vacuum - Automazione Pulizie Avanzata"
  description: |
    ü§ñ **Automazione avanzata per robot Dreame con logiche intelligenti**
    
    ‚ú® **NOVIT√Ä v2.0:**
    - üîÑ **Logica adattiva**: La sera si adatta al mattino
    - üîó **Pulizie sequenziali**: Pi√π stanze consecutive con attesa
    - ü§ñ **Controllo stato robot**: Verifica stato prima di iniziare
    - üìã **Pianificazione avanzata**: Template Jinja2 personalizzabili
    - üîî **Notifiche intelligenti**: Annunci Alexa opzionali
    - üêõ **Modalit√† debug**: Log dettagliati per troubleshooting
    
    üéØ **6 slot temporali configurabili**: Mattina + Sera + 4 Blocchi aggiuntivi
  
  domain: automation
  input:
    # ========================================
    # === ENTIT√Ä PRINCIPALI ===
    # ========================================
    vacuum_entity:
      name: ü§ñ Entit√† Vacuum
      description: |
        Seleziona il tuo robot Dreame.
        Esempio: `vacuum.ambrogio`
      selector:
        entity:
          domain: vacuum
          
    robot_status_sensor:
      name: üìä Sensore Stato Robot (Opzionale)
      description: |
        Sensore di stato dettagliato del robot per verifiche avanzate prima di iniziare.
        
        üîç **Come trovarlo:**
        - Generalmente: `sensor.NOME_ROBOT_status` o `sensor.NOME_ROBOT_state`
        - Esempio: se il robot √® `vacuum.ambrogio`, cerca `sensor.ambrogio_status`
        
        ‚ö†Ô∏è **Lascia vuoto per disabilitare** il controllo stato (pulizia partir√† sempre)
      default: ""
      selector:
        entity:
          domain: sensor
          
    valid_robot_states:
      name: ‚úÖ Stati Robot Validi
      description: |
        Stati in cui il robot pu√≤ iniziare una pulizia.
        Solo quando il robot √® in uno di questi stati la pulizia partir√†.
      default: ["idle", "sleeping", "charging", "docked"]
      selector:
        select:
          options:
            - "idle"
            - "sleeping" 
            - "charging"
            - "docked"
            - "paused"
            - "returning"
          multiple: true
          
    # ========================================
    # === CONTROLLO PRESENZA ===
    # ========================================
    presence_entity:
      name: üè† Entit√† Presenza (Opzionale)
      description: |
        Entit√† che indica se sei in casa o fuori casa.
        
        üí° **Esempi comuni:**
        - `person.il_tuo_nome` (entit√† Persona)
        - `binary_sensor.occupancy` (sensore presenza PIR)
        - `input_boolean.away_mode` (interruttore manuale) 
        - `counter.people_home` (contatore persone)
        
        ‚ö†Ô∏è **Lascia vuoto per disabilitare** il controllo presenza
      default: ""
      selector:
        entity: {}
        
    presence_value:
      name: üö™ Valore "Fuori Casa"
      description: |
        Il valore che l'entit√† presenza deve avere per indicare "fuori casa".
        
        üìù **Esempi comuni:**
        - `person.*` ‚Üí `"not_home"` o `"away"`
        - `binary_sensor.*` ‚Üí `"off"` (non rileva presenza)
        - `input_boolean.*` ‚Üí `"on"` (se acceso = via da casa)
        - `counter.*` ‚Üí `"0"` (nessuno in casa)
        
        üí° **Come scoprirlo:** Strumenti Sviluppatore ‚Üí Stati ‚Üí trova la tua entit√† quando sei fuori
      default: "not_home"
      
    # ========================================
    # === FLAG PULIZIA GIORNALIERO ===
    # ========================================
    flag_cleaned_today:
      name: üèÉ Flag "Pulito Oggi" 
      description: |
        Input boolean che traccia se √® gi√† stata fatta pulizia oggi.
        
        üÜï **Se non ce l'hai, crealo:**
        1. Nel menu a tendina clicca **"+ Crea nuova entit√†"**
        2. Seleziona **"Input Boolean"**
        3. Nome: "Pulito Oggi", ID: `cleaned_today`
        
        ‚ÑπÔ∏è Si accende dopo ogni pulizia, si spegne automaticamente a mezzanotte
      selector:
        entity:
          domain: input_boolean
          
    # ========================================
    # === NOTIFICHE E DEBUG ===
    # ========================================
    notification_targets:
      name: üîî Dispositivi Notifica (Opzionale)
      description: |
        Media player Alexa per annunci vocali automatici.
        
        üì± **Sintassi:**
        - Singolo: `media_player.echo_dot_soggiorno`
        - Multipli: `media_player.echo_soggiorno,media_player.alexa_cucina`
        
        üîç **Come trovarli:** Strumenti Sviluppatore ‚Üí Stati ‚Üí cerca `media_player.`
        
        ‚ö†Ô∏è **Lascia vuoto per disabilitare** le notifiche
      default: ""

    debug_mode:
      name: üêõ Modalit√† Debug
      description: |
        Abilita log dettagliati per troubleshooting.
        
        üìã **Utile per:**
        - Prima configurazione
        - Verificare funzionamento
        - Risolvere problemi
        
        üìù **Log in:** Impostazioni ‚Üí Sistema ‚Üí Log
      default: false
      selector:
        boolean: {}
        
    # ========================================
    # === SLOT MATTINA ===
    # ========================================
    morning_on:
      name: üåÖ MATTINA - Abilita
      description: Attiva la pulizia mattutina programmata
      default: true
      selector:
        boolean: {}
        
    morning_time:
      name: ‚è∞ MATTINA - Orario
      description: Orario di avvio pulizia mattutina
      default: "08:00:00"
      selector:
        time: {}
        
    morning_weekdays:
      name: üìÖ MATTINA - Giorni Settimana
      description: Giorni in cui eseguire la pulizia mattutina
      default: ["monday", "tuesday", "wednesday", "thursday", "friday"]
      selector:
        select:
          options: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
          multiple: true
          
    morning_schedule_template:
      name: üìã MATTINA - Pianificazione Avanzata (Opzionale)
      description: |
        Template Jinja2 per controlli personalizzati (lascia vuoto per usare solo i giorni).
        
        üìù **Esempi:**
        - `now().isoweekday() == 1` (solo Luned√¨)
        - `now().isoweekday() in [1,3,5]` (Lun/Mer/Ven)
        - `now().day % 2 == 0` (giorni pari del mese)
      default: ""
      
    morning_preset:
      name: üéØ MATTINA - Modalit√† Pulizia
      description: |
        Modalit√† di pulizia da utilizzare.
        
        üìã **Opzioni:**
        - **aspira**: Solo aspirazione
        - **lava**: Solo lavaggio
        - **pulisci**: Aspirazione + lavaggio
        - **cleangenius**: Modalit√† intelligente standard
        - **cleangenius_deep**: Modalit√† intelligente approfondita
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    morning_rooms:
      name: üè† MATTINA - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
        
        üìù **Esempi:**
        - `2,3,4` (stanze con ID 2, 3 e 4)
        - `cucina,soggiorno` (per nome)
        - `` (vuoto = tutta la casa)
      default: ""
      
    # === MATTINA - PULIZIE SEQUENZIALI ===
    morning_sequential:
      name: üîó MATTINA - Pulizia Sequenziale
      description: |
        **Pulizia sequenziale** = esegue pi√π pulizie consecutive attendendo il completamento di ogni step.
        
        üìã **Esempio:** Prima aspira il soggiorno, attende che finisca, poi pulisce la cucina.
        
        ‚ö†Ô∏è Se disabilitato, esegue solo lo Step 1
      default: false
      selector:
        boolean: {}
        
    morning_step2_preset:
      name: üéØ MATTINA - Step 2 - Modalit√†
      description: Modalit√† di pulizia per il secondo step (solo se sequenziale abilitato)
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    morning_step2_rooms:
      name: üè† MATTINA - Step 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
        
        Stanze da pulire nel secondo step sequenziale.
      default: ""
      
    morning_step3_preset:
      name: üéØ MATTINA - Step 3 - Modalit√†
      description: Modalit√† di pulizia per il terzo step (solo se sequenziale abilitato)
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    morning_step3_rooms:
      name: üè† MATTINA - Step 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
        
        Stanze da pulire nel terzo step sequenziale.
      default: ""
      
    morning_max_wait:
      name: ‚è±Ô∏è MATTINA - Timeout Attesa (minuti)
      description: |
        Tempo massimo di attesa completamento tra step sequenziali.
        
        ‚ö†Ô∏è Se il robot non finisce entro questo tempo, passa allo step successivo comunque.
      default: 60
      selector:
        number:
          min: 10
          max: 180
          unit_of_measurement: "min"
          
    # ========================================
    # === SLOT SERA ===
    # ========================================
    evening_on:
      name: üåô SERA - Abilita
      description: Attiva la pulizia serale programmata
      default: true
      selector:
        boolean: {}
        
    evening_time:
      name: ‚è∞ SERA - Orario
      description: Orario di avvio pulizia serale
      default: "18:00:00"
      selector:
        time: {}
        
    evening_weekdays:
      name: üìÖ SERA - Giorni Settimana
      description: Giorni in cui eseguire la pulizia serale
      default: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
      selector:
        select:
          options: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
          multiple: true
          
    evening_schedule_template:
      name: üìã SERA - Pianificazione Avanzata (Opzionale)
      description: |
        Template Jinja2 per controlli personalizzati (lascia vuoto per usare solo i giorni).
      default: ""
      
    # === SERA - LOGICA ADATTIVA ===
    evening_conditional:
      name: üß† SERA - Logica Adattiva
      description: |
        **Logica adattiva** = come comportarsi in base alla pulizia mattutina.
        
        üìã **Opzioni:**
        - **always**: Esegui sempre (come prima)
        - **skip_if_cleaned**: Salta se gi√† pulito oggi
        - **fallback_if_not_cleaned**: Esegui solo se NON pulito oggi  
        - **adapt_if_cleaned**: Cambia modalit√† se gi√† pulito oggi
        
        üí° **Utile per evitare doppie pulizie o adattare l'intensit√†**
      default: "always"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se gi√† pulito oggi"
              value: "skip_if_cleaned"
            - label: "Esegui solo se NON pulito oggi"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalit√† se gi√† pulito"
              value: "adapt_if_cleaned"
              
    evening_preset:
      name: üéØ SERA - Modalit√† Pulizia
      description: Modalit√† di pulizia normale per la sera
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    evening_rooms:
      name: üè† SERA - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
        
        Stanze da pulire normalmente la sera.
      default: ""
      
    # === SERA - MODALIT√Ä ALTERNATIVA ===
    evening_fallback_preset:
      name: üîÑ SERA - Modalit√† Alternativa
      description: |
        Modalit√† da usare con logica "adapt_if_cleaned".
        
        üí° **Esempio:** Se gi√† pulito, invece di CleanGenius usa solo Aspirazione
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    evening_fallback_rooms:
      name: üîÑ SERA - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
        
        Stanze da pulire con modalit√† alternativa (es. solo cucina invece di tutta casa).
      default: ""
      
    # === SERA - SEQUENZIALI ===
    evening_sequential:
      name: üîó SERA - Pulizia Sequenziale
      description: |
        **Pulizia sequenziale** = esegue pi√π pulizie consecutive attendendo il completamento.
      default: false
      selector:
        boolean: {}
        
    evening_step2_preset:
      name: üéØ SERA - Step 2 - Modalit√†
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    evening_step2_rooms:
      name: üè† SERA - Step 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    evening_step3_preset:
      name: üéØ SERA - Step 3 - Modalit√†
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    evening_step3_rooms:
      name: üè† SERA - Step 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    evening_max_wait:
      name: ‚è±Ô∏è SERA - Timeout Attesa (minuti)
      default: 60
      selector:
        number:
          min: 10
          max: 180
          unit_of_measurement: "min"
          
    # ========================================
    # === BLOCCO 1 ===
    # ======================================== 
    block1_on:
      name: üéØ BLOCCO 1 - Abilita
      description: Attiva il primo blocco di pulizia aggiuntivo
      default: false
      selector:
        boolean: {}
        
    block1_time:
      name: ‚è∞ BLOCCO 1 - Orario
      default: "12:00:00"
      selector:
        time: {}
        
    block1_weekdays:
      name: üìÖ BLOCCO 1 - Giorni Settimana
      default: ["saturday", "sunday"]
      selector:
        select:
          options: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
          multiple: true
          
    block1_schedule_template:
      name: üìã BLOCCO 1 - Pianificazione Avanzata (Opzionale)
      default: ""
      
    block1_conditional:
      name: üß† BLOCCO 1 - Logica Adattiva
      description: Come comportarsi in base alle pulizie precedenti
      default: "always"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se gi√† pulito oggi"
              value: "skip_if_cleaned"
            - label: "Esegui solo se NON pulito oggi"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalit√† se gi√† pulito"
              value: "adapt_if_cleaned"
              
    block1_preset:
      name: üéØ BLOCCO 1 - Modalit√† Pulizia
      default: "pulisci"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block1_rooms:
      name: üè† BLOCCO 1 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block1_fallback_preset:
      name: üîÑ BLOCCO 1 - Modalit√† Alternativa
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block1_fallback_rooms:
      name: üîÑ BLOCCO 1 - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block1_sequential:
      name: üîó BLOCCO 1 - Pulizia Sequenziale
      description: |
        **Pulizia sequenziale** = esegue pi√π pulizie consecutive attendendo il completamento.
      default: false
      selector:
        boolean: {}
        
    block1_step2_preset:
      name: üéØ BLOCCO 1 - Step 2 - Modalit√†
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block1_step2_rooms:
      name: üè† BLOCCO 1 - Step 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block1_step3_preset:
      name: üéØ BLOCCO 1 - Step 3 - Modalit√†
      default: "aspira"  
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block1_step3_rooms:
      name: üè† BLOCCO 1 - Step 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block1_max_wait:
      name: ‚è±Ô∏è BLOCCO 1 - Timeout Attesa (minuti)
      default: 60
      selector:
        number:
          min: 10
          max: 180
          unit_of_measurement: "min"

    # ========================================
    # === BLOCCO 2 === 
    # ========================================
    block2_on:
      name: üéØ BLOCCO 2 - Abilita
      description: Attiva il secondo blocco di pulizia aggiuntivo
      default: false
      selector:
        boolean: {}
        
    block2_time:
      name: ‚è∞ BLOCCO 2 - Orario
      default: "14:00:00"
      selector:
        time: {}
        
    block2_weekdays:
      name: üìÖ BLOCCO 2 - Giorni Settimana
      default: ["saturday", "sunday"]
      selector:
        select:
          options: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
          multiple: true
          
    block2_schedule_template:
      name: üìã BLOCCO 2 - Pianificazione Avanzata (Opzionale)
      default: ""
      
    block2_conditional:
      name: üß† BLOCCO 2 - Logica Adattiva
      default: "always"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se gi√† pulito oggi"
              value: "skip_if_cleaned"
            - label: "Esegui solo se NON pulito oggi"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalit√† se gi√† pulito"
              value: "adapt_if_cleaned"
              
    block2_preset:
      name: üéØ BLOCCO 2 - Modalit√† Pulizia
      default: "pulisci"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block2_rooms:
      name: üè† BLOCCO 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block2_fallback_preset:
      name: üîÑ BLOCCO 2 - Modalit√† Alternativa
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block2_fallback_rooms:
      name: üîÑ BLOCCO 2 - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block2_sequential:
      name: üîó BLOCCO 2 - Pulizia Sequenziale
      default: false
      selector:
        boolean: {}
        
    block2_step2_preset:
      name: üéØ BLOCCO 2 - Step 2 - Modalit√†
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block2_step2_rooms:
      name: üè† BLOCCO 2 - Step 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block2_step3_preset:
      name: üéØ BLOCCO 2 - Step 3 - Modalit√†
      default: "aspira"  
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block2_step3_rooms:
      name: üè† BLOCCO 2 - Step 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block2_max_wait:
      name: ‚è±Ô∏è BLOCCO 2 - Timeout Attesa (minuti)
      default: 60
      selector:
        number:
          min: 10
          max: 180
          unit_of_measurement: "min"

    # ========================================
    # === BLOCCO 3 === 
    # ========================================
    block3_on:
      name: üéØ BLOCCO 3 - Abilita
      description: Attiva il terzo blocco di pulizia aggiuntivo
      default: false
      selector:
        boolean: {}
        
    block3_time:
      name: ‚è∞ BLOCCO 3 - Orario
      default: "16:00:00"
      selector:
        time: {}
        
    block3_weekdays:
      name: üìÖ BLOCCO 3 - Giorni Settimana
      default: ["saturday", "sunday"]
      selector:
        select:
          options: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
          multiple: true
          
    block3_schedule_template:
      name: üìã BLOCCO 3 - Pianificazione Avanzata (Opzionale)
      default: ""
      
    block3_conditional:
      name: üß† BLOCCO 3 - Logica Adattiva
      default: "always"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se gi√† pulito oggi"
              value: "skip_if_cleaned"
            - label: "Esegui solo se NON pulito oggi"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalit√† se gi√† pulito"
              value: "adapt_if_cleaned"
              
    block3_preset:
      name: üéØ BLOCCO 3 - Modalit√† Pulizia
      default: "pulisci"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block3_rooms:
      name: üè† BLOCCO 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block3_fallback_preset:
      name: üîÑ BLOCCO 3 - Modalit√† Alternativa
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block3_fallback_rooms:
      name: üîÑ BLOCCO 3 - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block3_sequential:
      name: üîó BLOCCO 3 - Pulizia Sequenziale
      default: false
      selector:
        boolean: {}
        
    block3_step2_preset:
      name: üéØ BLOCCO 3 - Step 2 - Modalit√†
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block3_step2_rooms:
      name: üè† BLOCCO 3 - Step 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block3_step3_preset:
      name: üéØ BLOCCO 3 - Step 3 - Modalit√†
      default: "aspira"  
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block3_step3_rooms:
      name: üè† BLOCCO 3 - Step 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block3_max_wait:
      name: ‚è±Ô∏è BLOCCO 3 - Timeout Attesa (minuti)
      default: 60
      selector:
        number:
          min: 10
          max: 180
          unit_of_measurement: "min"

    # ========================================
    # === BLOCCO 4 === 
    # ========================================
    block4_on:
      name: üéØ BLOCCO 4 - Abilita
      description: Attiva il quarto blocco di pulizia aggiuntivo
      default: false
      selector:
        boolean: {}
        
    block4_time:
      name: ‚è∞ BLOCCO 4 - Orario
      default: "20:00:00"
      selector:
        time: {}
        
    block4_weekdays:
      name: üìÖ BLOCCO 4 - Giorni Settimana
      default: ["saturday", "sunday"]
      selector:
        select:
          options: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
          multiple: true
          
    block4_schedule_template:
      name: üìã BLOCCO 4 - Pianificazione Avanzata (Opzionale)
      default: ""
      
    block4_conditional:
      name: üß† BLOCCO 4 - Logica Adattiva
      default: "always"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se gi√† pulito oggi"
              value: "skip_if_cleaned"
            - label: "Esegui solo se NON pulito oggi"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalit√† se gi√† pulito"
              value: "adapt_if_cleaned"
              
    block4_preset:
      name: üéØ BLOCCO 4 - Modalit√† Pulizia
      default: "pulisci"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block4_rooms:
      name: üè† BLOCCO 4 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block4_fallback_preset:
      name: üîÑ BLOCCO 4 - Modalit√† Alternativa
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block4_fallback_rooms:
      name: üîÑ BLOCCO 4 - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block4_sequential:
      name: üîó BLOCCO 4 - Pulizia Sequenziale
      default: false
      selector:
        boolean: {}
        
    block4_step2_preset:
      name: üéØ BLOCCO 4 - Step 2 - Modalit√†
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block4_step2_rooms:
      name: üè† BLOCCO 4 - Step 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block4_step3_preset:
      name: üéØ BLOCCO 4 - Step 3 - Modalit√†
      default: "aspira"  
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    block4_step3_rooms:
      name: üè† BLOCCO 4 - Step 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi stanze separati da virgola. Lascia vuoto per tutta la casa.**
      default: ""
      
    block4_max_wait:
      name: ‚è±Ô∏è BLOCCO 4 - Timeout Attesa (minuti)
      default: 60
      selector:
        number:
          min: 10
          max: 180
          unit_of_measurement: "min"

# =========================================
# === TRIGGERS E AZIONI ===
# =========================================
trigger:
  - platform: time
    at: !input morning_time
    id: morning
  - platform: time  
    at: !input evening_time
    id: evening
  - platform: time
    at: !input block1_time
    id: block1
  - platform: time
    at: !input block2_time
    id: block2
  - platform: time
    at: !input block3_time
    id: block3
  - platform: time
    at: !input block4_time
    id: block4
  # Reset flag giornaliero
  - platform: time
    at: "23:59:00"
    id: reset_flag

variables:
  # Entit√† principali
  vacuum_ent: !input vacuum_entity
  robot_status: !input robot_status_sensor
  valid_states: !input valid_robot_states
  presence_ent: !input presence_entity
  pres_val: !input presence_value
  flag_cleaned: !input flag_cleaned_today
  notification_targets: !input notification_targets
  debug_enabled: !input debug_mode

action:
  # === RESET FLAG GIORNALIERO ===
  - if:
      - condition: template
        value_template: "{{ trigger.id == 'reset_flag' }}"
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: "[DREAME BLUEPRINT] üåô Reset flag pulizia giornaliero"
              level: info
      - service: input_boolean.turn_off
        target:
          entity_id: "{{ flag_cleaned }}"
      - stop: "Reset flag completato"

  # === LOGICA PRINCIPALE ===
  - choose:
      # ===== MATTINA =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'morning' }}"
          - condition: template
            value_template: !input morning_on
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {{ current_weekday in morning_weekdays }}
          - condition: template
            value_template: |
              {% if morning_schedule_template != '' %}
                {{ morning_schedule_template | bool }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if robot_status != '' %}
                {{ states(robot_status) in valid_states }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if presence_ent != '' %}
                {{ states(presence_ent) == pres_val }}
              {% else %}
                true
              {% endif %}
        sequence:
          - variables:
              slot_name: "MATTINA"
              slot_preset: !input morning_preset
              slot_rooms: !input morning_rooms
              slot_sequential: !input morning_sequential
              slot_step2_preset: !input morning_step2_preset
              slot_step2_rooms: !input morning_step2_rooms
              slot_step3_preset: !input morning_step3_preset
              slot_step3_rooms: !input morning_step3_rooms
              slot_max_wait: !input morning_max_wait
          - sequence: &execute_cleaning_sequence
              # === LOG DEBUG ===
              - if:
                  - condition: template
                    value_template: "{{ debug_enabled }}"
                then:
                  - service: system_log.write
                    data:
                      message: >
                        [DREAME BLUEPRINT] üöÄ Avvio pulizia {{ slot_name }}
                        - Preset: {{ slot_preset }}
                        - Stanze: {{ slot_rooms }}
                        - Sequenziale: {{ slot_sequential }}
                        - Robot Status: {{ states(robot_status) if robot_status != '' else 'N/A' }}
                        - Flag Cleaned: {{ states(flag_cleaned) }}
                      level: info
              
              # === NOTIFICA INIZIO ===
              - if:
                  - condition: template
                    value_template: "{{ notification_targets != '' }}"
                then:
                  - repeat:
                      count: >
                        {{ notification_targets.split(',') | length }}
                      sequence:
                        - service: tts.speak
                          target:
                            entity_id: >
                              {{ notification_targets.split(',')[repeat.index - 1].strip() }}
                          data:
                            message: >
                              Avvio pulizia {{ slot_name.lower() }}
                              {% if slot_rooms != '' %}
                              nelle stanze: {{ slot_rooms }}
                              {% endif %}
              
              # === PULIZIA STEP 1 ===
              - variables:
                  preset_now: "{{ slot_preset }}"
                  rooms_now: "{{ slot_rooms }}"
              - sequence: &run_cleaning_step
                  - variables:
                      rooms_list: >
                        {% if rooms_now == '' %}
                          []
                        {% else %}
                          {% set room_ids = [] %}
                          {% for room in rooms_now.split(',') %}
                            {% set room = room.strip() %}
                            {% if room.isdigit() %}
                              {% set room_ids = room_ids + [room|int] %}
                            {% else %}
                              {% for entity in states.sensor %}
                                {% if entity.entity_id.startswith(vacuum_ent ~ '_room_') and entity.attributes.get('friendly_name', '').lower() == room.lower() %}
                                  {% set room_ids = room_ids + [entity.state|int] %}
                                {% endif %}
                              {% endfor %}
                            {% endif %}
                          {% endfor %}
                          {{ room_ids }}
                        {% endif %}
                        
                  - choose:
                      # CleanGenius modalit√†
                      - conditions: 
                          - condition: template
                            value_template: "{{ preset_now in ['cleangenius', 'cleangenius_deep'] }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ vacuum_ent }}_cleangenius"  
                            data:
                              option: >
                                {% if preset_now == 'cleangenius_deep' %}
                                  cleaning_route
                                {% else %}
                                  standard_cleaning
                                {% endif %}
                          - if:
                              - condition: template
                                value_template: "{{ rooms_list | length > 0 }}"
                            then:
                              - service: vacuum.send_command
                                target:
                                  entity_id: "{{ vacuum_ent }}"
                                data:
                                  command: app_segment_clean
                                  params: "{{ rooms_list }}"
                            else:
                              - service: vacuum.start
                                target:
                                  entity_id: "{{ vacuum_ent }}"
                                  
                      # Modalit√† standard
                      - conditions: 
                          - condition: template
                            value_template: "{{ preset_now in ['aspira', 'lava', 'pulisci'] }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ vacuum_ent }}_cleaning_mode"
                            data:
                              option: >
                                {% if preset_now == 'aspira' %}
                                  vacuuming
                                {% elif preset_now == 'lava' %}
                                  mopping
                                {% else %}
                                  vacuuming_and_mopping  
                                {% endif %}
                          - if:
                              - condition: template
                                value_template: "{{ rooms_list | length > 0 }}"
                            then:
                              - service: vacuum.send_command
                                target:
                                  entity_id: "{{ vacuum_ent }}"
                                data:
                                  command: app_segment_clean
                                  params: "{{ rooms_list }}"
                            else:
                              - service: vacuum.start
                                target:
                                  entity_id: "{{ vacuum_ent }}"
              
              # === ATTESA COMPLETAMENTO PER STEP SUCCESSIVI ===
              - if:
                  - condition: template
                    value_template: "{{ slot_sequential and (slot_step2_preset != '' or slot_step3_preset != '') }}"
                then:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: system_log.write
                        data:
                          message: "[DREAME BLUEPRINT] ‚è≥ Attesa completamento Step 1..."
                          level: info
                  
                  - wait_for_trigger:
                      - platform: state
                        entity_id: "{{ robot_status if robot_status != '' else vacuum_ent }}"
                        to: ["idle", "sleeping", "charging", "docked"]
                        for: "00:00:10"
                    timeout: "{{ (slot_max_wait * 60) | int }}"
                    
                  - if:
                      - condition: template
                        value_template: "{{ wait.completed }}"
                      - condition: template
                        value_template: "{{ slot_step2_preset != '' }}"
                    then:
                      # === PULIZIA STEP 2 ===
                      - if:
                          - condition: template
                            value_template: "{{ debug_enabled }}"
                        then:
                          - service: system_log.write
                            data:
                              message: "[DREAME BLUEPRINT] üöÄ Avvio Step 2"
                              level: info
                      
                      - variables:
                          preset_now: "{{ slot_step2_preset }}"
                          rooms_now: "{{ slot_step2_rooms }}"
                      - sequence: *run_cleaning_step
                      
                      # === ATTESA PER STEP 3 ===
                      - if:
                          - condition: template
                            value_template: "{{ slot_step3_preset != '' }}"
                        then:
                          - wait_for_trigger:
                              - platform: state
                                entity_id: "{{ robot_status if robot_status != '' else vacuum_ent }}"
                                to: ["idle", "sleeping", "charging", "docked"]
                                for: "00:00:10"
                            timeout: "{{ (slot_max_wait * 60) | int }}"
                            
                          - if:
                              - condition: template
                                value_template: "{{ wait.completed }}"
                            then:
                              # === PULIZIA STEP 3 ===
                              - if:
                                  - condition: template
                                    value_template: "{{ debug_enabled }}"
                                then:
                                  - service: system_log.write
                                    data:
                                      message: "[DREAME BLUEPRINT] üöÄ Avvio Step 3"
                                      level: info
                              
                              - variables:
                                  preset_now: "{{ slot_step3_preset }}"
                                  rooms_now: "{{ slot_step3_rooms }}"
                              - sequence: *run_cleaning_step
              
              # === IMPOSTA FLAG PULIZIA ===
              - service: input_boolean.turn_on
                target:
                  entity_id: "{{ flag_cleaned }}"
                  
              # === NOTIFICA COMPLETAMENTO ===
              - if:
                  - condition: template
                    value_template: "{{ notification_targets != '' }}"
                then:
                  - repeat:
                      count: >
                        {{ notification_targets.split(',') | length }}
                      sequence:
                        - service: tts.speak
                          target:
                            entity_id: >
                              {{ notification_targets.split(',')[repeat.index - 1].strip() }}
                          data:
                            message: "Pulizia {{ slot_name.lower() }} avviata con successo"

      # ===== SERA (CON LOGICA ADATTIVA) =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'evening' }}"
          - condition: template
            value_template: !input evening_on
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {{ current_weekday in evening_weekdays }}
          - condition: template
            value_template: |
              {% if evening_schedule_template != '' %}
                {{ evening_schedule_template | bool }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if robot_status != '' %}
                {{ states(robot_status) in valid_states }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if presence_ent != '' %}
                {{ states(presence_ent) == pres_val }}
              {% else %}
                true
              {% endif %}
        sequence:
          # === LOGICA ADATTIVA ===
          - choose:
              # Skip se gi√† pulito
              - conditions:
                  - condition: template
                    value_template: !input evening_conditional == 'skip_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: system_log.write
                        data:
                          message: "[DREAME BLUEPRINT] ‚è≠Ô∏è Pulizia SERA saltata - gi√† pulito oggi"
                          level: info
                  - stop: "Pulizia gi√† effettuata oggi"
              
              # Esegui solo se non pulito
              - conditions:
                  - condition: template
                    value_template: !input evening_conditional == 'fallback_if_not_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'off') }}"
                sequence:
                  - variables:
                      slot_name: "SERA (Recupero)"
                      slot_preset: !input evening_preset
                      slot_rooms: !input evening_rooms
                      slot_sequential: !input evening_sequential
                      slot_step2_preset: !input evening_step2_preset
                      slot_step2_rooms: !input evening_step2_rooms
                      slot_step3_preset: !input evening_step3_preset
                      slot_step3_rooms: !input evening_step3_rooms
                      slot_max_wait: !input evening_max_wait
                  - sequence: *execute_cleaning_sequence
              
              # Adatta modalit√† se gi√† pulito
              - conditions:
                  - condition: template
                    value_template: !input evening_conditional == 'adapt_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - variables:
                      slot_name: "SERA (Modalit√† Leggera)"
                      slot_preset: !input evening_fallback_preset
                      slot_rooms: !input evening_fallback_rooms
                      slot_sequential: !input evening_sequential
                      slot_step2_preset: !input evening_step2_preset
                      slot_step2_rooms: !input evening_step2_rooms
                      slot_step3_preset: !input evening_step3_preset
                      slot_step3_rooms: !input evening_step3_rooms
                      slot_max_wait: !input evening_max_wait
                  - sequence: *execute_cleaning_sequence
              
              # Esegui sempre (modalit√† normale)
              - conditions: []
                sequence:
                  - variables:
                      slot_name: "SERA"
                      slot_preset: !input evening_preset
                      slot_rooms: !input evening_rooms
                      slot_sequential: !input evening_sequential
                      slot_step2_preset: !input evening_step2_preset
                      slot_step2_rooms: !input evening_step2_rooms
                      slot_step3_preset: !input evening_step3_preset
                      slot_step3_rooms: !input evening_step3_rooms
                      slot_max_wait: !input evening_max_wait
                  - sequence: *execute_cleaning_sequence

      # ===== BLOCCO 1 =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'block1' }}"
          - condition: template
            value_template: !input block1_on
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {{ current_weekday in block1_weekdays }}
          - condition: template
            value_template: |
              {% if block1_schedule_template != '' %}
                {{ block1_schedule_template | bool }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if robot_status != '' %}
                {{ states(robot_status) in valid_states }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if presence_ent != '' %}
                {{ states(presence_ent) == pres_val }}
              {% else %}
                true
              {% endif %}
        sequence:
          - choose:
              # Skip se gi√† pulito
              - conditions:
                  - condition: template
                    value_template: !input block1_conditional == 'skip_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: system_log.write
                        data:
                          message: "[DREAME BLUEPRINT] ‚è≠Ô∏è Pulizia BLOCCO 1 saltata - gi√† pulito oggi"
                          level: info
                  - stop: "Pulizia gi√† effettuata oggi"
              
              # Esegui solo se non pulito
              - conditions:
                  - condition: template
                    value_template: !input block1_conditional == 'fallback_if_not_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'off') }}"
                sequence:
                  - variables:
                      slot_name: "BLOCCO 1 (Recupero)"
                      slot_preset: !input block1_preset
                      slot_rooms: !input block1_rooms
                      slot_sequential: !input block1_sequential
                      slot_step2_preset: !input block1_step2_preset
                      slot_step2_rooms: !input block1_step2_rooms
                      slot_step3_preset: !input block1_step3_preset
                      slot_step3_rooms: !input block1_step3_rooms
                      slot_max_wait: !input block1_max_wait
                  - sequence: *execute_cleaning_sequence
              
              # Adatta modalit√† se gi√† pulito
              - conditions:
                  - condition: template
                    value_template: !input block1_conditional == 'adapt_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - variables:
                      slot_name: "BLOCCO 1 (Modalit√† Leggera)"
                      slot_preset: !input block1_fallback_preset
                      slot_rooms: !input block1_fallback_rooms
                      slot_sequential: !input block1_sequential
                      slot_step2_preset: !input block1_step2_preset
                      slot_step2_rooms: !input block1_step2_rooms
                      slot_step3_preset: !input block1_step3_preset
                      slot_step3_rooms: !input block1_step3_rooms
                      slot_max_wait: !input block1_max_wait
                  - sequence: *execute_cleaning_sequence
              
              # Esegui sempre
              - conditions: []
                sequence:
                  - variables:
                      slot_name: "BLOCCO 1"
                      slot_preset: !input block1_preset
                      slot_rooms: !input block1_rooms
                      slot_sequential: !input block1_sequential
                      slot_step2_preset: !input block1_step2_preset
                      slot_step2_rooms: !input block1_step2_rooms
                      slot_step3_preset: !input block1_step3_preset
                      slot_step3_rooms: !input block1_step3_rooms
                      slot_max_wait: !input block1_max_wait
                  - sequence: *execute_cleaning_sequence

      # ===== BLOCCO 2 =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'block2' }}"
          - condition: template
            value_template: !input block2_on
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: !input block2_conditional == 'skip_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - stop: "Pulizia gi√† effettuata oggi"
              
              - conditions:
                  - condition: template
                    value_template: !input block2_conditional == 'fallback_if_not_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'off') }}"
                sequence:
                  - variables:
                      slot_name: "BLOCCO 2 (Recupero)"
                      slot_preset: !input block2_preset
                      slot_rooms: !input block2_rooms
                      slot_sequential: !input block2_sequential
                      slot_step2_preset: !input block2_step2_preset
                      slot_step2_rooms: !input block2_step2_rooms
                      slot_step3_preset: !input block2_step3_preset
                      slot_step3_rooms: !input block2_step3_rooms
                      slot_max_wait: !input block2_max_wait
                  - sequence: *execute_cleaning_sequence
              
              - conditions:
                  - condition: template
                    value_template: !input block2_conditional == 'adapt_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - variables:
                      slot_name: "BLOCCO 2 (Modalit√† Leggera)"
                      slot_preset: !input block2_fallback_preset
                      slot_rooms: !input block2_fallback_rooms
                      slot_sequential: !input block2_sequential
                      slot_step2_preset: !input block2_step2_preset
                      slot_step2_rooms: !input block2_step2_rooms
                      slot_step3_preset: !input block2_step3_preset
                      slot_step3_rooms: !input block2_step3_rooms
                      slot_max_wait: !input block2_max_wait
                  - sequence: *execute_cleaning_sequence
              
              - conditions: []
                sequence:
                  - variables:
                      slot_name: "BLOCCO 2"
                      slot_preset: !input block2_preset
                      slot_rooms: !input block2_rooms
                      slot_sequential: !input block2_sequential
                      slot_step2_preset: !input block2_step2_preset
                      slot_step2_rooms: !input block2_step2_rooms
                      slot_step3_preset: !input block2_step3_preset
                      slot_step3_rooms: !input block2_step3_rooms
                      slot_max_wait: !input block2_max_wait
                  - sequence: *execute_cleaning_sequence

      # ===== BLOCCO 3 =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'block3' }}"
          - condition: template
            value_template: !input block3_on
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: !input block3_conditional == 'skip_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - stop: "Pulizia gi√† effettuata oggi"
              
              - conditions:
                  - condition: template
                    value_template: !input block3_conditional == 'fallback_if_not_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'off') }}"
                sequence:
                  - variables:
                      slot_name: "BLOCCO 3 (Recupero)"
                      slot_preset: !input block3_preset
                      slot_rooms: !input block3_rooms
                      slot_sequential: !input block3_sequential
                      slot_step2_preset: !input block3_step2_preset
                      slot_step2_rooms: !input block3_step2_rooms
                      slot_step3_preset: !input block3_step3_preset
                      slot_step3_rooms: !input block3_step3_rooms
                      slot_max_wait: !input block3_max_wait
                  - sequence: *execute_cleaning_sequence
              
              - conditions:
                  - condition: template
                    value_template: !input block3_conditional == 'adapt_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - variables:
                      slot_name: "BLOCCO 3 (Modalit√† Leggera)"
                      slot_preset: !input block3_fallback_preset
                      slot_rooms: !input block3_fallback_rooms
                      slot_sequential: !input block3_sequential
                      slot_step2_preset: !input block3_step2_preset
                      slot_step2_rooms: !input block3_step2_rooms
                      slot_step3_preset: !input block3_step3_preset
                      slot_step3_rooms: !input block3_step3_rooms
                      slot_max_wait: !input block3_max_wait
                  - sequence: *execute_cleaning_sequence
              
              - conditions: []
                sequence:
                  - variables:
                      slot_name: "BLOCCO 3"
                      slot_preset: !input block3_preset
                      slot_rooms: !input block3_rooms
                      slot_sequential: !input block3_sequential
                      slot_step2_preset: !input block3_step2_preset
                      slot_step2_rooms: !input block3_step2_rooms
                      slot_step3_preset: !input block3_step3_preset
                      slot_step3_rooms: !input block3_step3_rooms
                      slot_max_wait: !input block3_max_wait
                  - sequence: *execute_cleaning_sequence

      # ===== BLOCCO 4 =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'block4' }}"
          - condition: template
            value_template: !input block4_on
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: !input block4_conditional == 'skip_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - stop: "Pulizia gi√† effettuata oggi"
              
              - conditions:
                  - condition: template
                    value_template: !input block4_conditional == 'fallback_if_not_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'off') }}"
                sequence:
                  - variables:
                      slot_name: "BLOCCO 4 (Recupero)"
                      slot_preset: !input block4_preset
                      slot_rooms: !input block4_rooms
                      slot_sequential: !input block4_sequential
                      slot_step2_preset: !input block4_step2_preset
                      slot_step2_rooms: !input block4_step2_rooms
                      slot_step3_preset: !input block4_step3_preset
                      slot_step3_rooms: !input block4_step3_rooms
                      slot_max_wait: !input block4_max_wait
                  - sequence: *execute_cleaning_sequence
              
              - conditions:
                  - condition: template
                    value_template: !input block4_conditional == 'adapt_if_cleaned'
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - variables:
                      slot_name: "BLOCCO 4 (Modalit√† Leggera)"
                      slot_preset: !input block4_fallback_preset
                      slot_rooms: !input block4_fallback_rooms
                      slot_sequential: !input block4_sequential
                      slot_step2_preset: !input block4_step2_preset
                      slot_step2_rooms: !input block4_step2_rooms
                      slot_step3_preset: !input block4_step3_preset
                      slot_step3_rooms: !input block4_step3_rooms
                      slot_max_wait: !input block4_max_wait
                  - sequence: *execute_cleaning_sequence
              
              - conditions: []
                sequence:
                  - variables:
                      slot_name: "BLOCCO 4"
                      slot_preset: !input block4_preset
                      slot_rooms: !input block4_rooms
                      slot_sequential: !input block4_sequential
                      slot_step2_preset: !input block4_step2_preset
                      slot_step2_rooms: !input block4_step2_rooms
                      slot_step3_preset: !input block4_step3_preset
                      slot_step3_rooms: !input block4_step3_rooms
                      slot_max_wait: !input block4_max_wait
                  - sequence: *execute_cleaning_sequence

mode: single
max_exceeded: silent
