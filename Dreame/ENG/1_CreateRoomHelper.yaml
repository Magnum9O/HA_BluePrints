blueprint:
  name: "ðŸ  Dreame: Room Helper Creation"
  description: |
    ## ðŸ“‹ Prerequisites
    - **Vacuum Map Card** configured and working
    - Dreame/Tasshack integration active
    
    ## ðŸŽ¯ What this blueprint does
    Creates an **intelligent script** that automatically:
    
    âœ… Reads the `rooms` attribute from your robot's map  
    âœ… Updates an `input_select` helper with all available rooms  
    âœ… Formats each entry as **"Room Name (ID)"** for easy identification  
    âœ… Notifies you if no configured rooms are found  
    
    ## ðŸ”§ How to use it
    1. **Select** your robot's map camera
    2. **Create** a new `input_select` helper (or select an existing one)
    3. **Run** the generated script
    4. **Check** the helper to see all rooms with their IDs
    
    ## ðŸ’¡ Example result
    ```
    Kitchen (3)
    Living Room (1)
    Bathroom (5)
    Bedroom (2)
    ```
    
    ## ðŸ”— Next step
    Use the IDs found with the **"ðŸŽ™ï¸ Alexa: Room Cleaning Scripts"** blueprint to create custom voice commands!
    
  domain: script
  source_url: https://raw.githubusercontent.com/Magnum9O/HA_BluePrints/main/Dreame/ENG/1_CreateRoomHelper.yaml
  input:
    map_camera:
      name: "ðŸ—ºï¸ Robot Map"
      description: |
        Select the **camera** entity that contains the `rooms` attribute of your Vacuum Map Card.
        
        ðŸ’¡ **Tip**: Usually named something like `camera.vacuum_map` or similar.
      selector:
        entity:
          domain: camera
    select_entity:
      name: "ðŸ“ Room Input Select Helper"
      description: |
        **First create** a new `input_select` helper from Home Assistant settings, then select it here.
        
        ðŸ”§ **Where to create it**: 
        - Settings â†’ Devices & Services â†’ Helpers â†’ Create Helper â†’ Dropdown
        - **OR** from the dropdown menu below: **+ Create new helper**
        
        âš ï¸ **Important**: The helper will be automatically populated with the rooms found.
      selector:
        entity:
          domain: input_select

sequence:
  # Local variables for map and input select
  - variables:
      map_ent: !input map_camera
      select_ent: !input select_entity
      # Build a list of rooms formatted as "Name (ID)" from the rooms attribute.
      room_options: >-
        {% set ns = namespace(opts=[]) %}
        {% set rooms = state_attr(map_ent, 'rooms') %}
        {% if rooms %}
          {% for pair in rooms | dictsort %}
            {% set key = pair[0] %}
            {% set val = pair[1] %}
            {% set name = (val['name'] if 'name' in val else key) %}
            {% set rid = (val['room_id'] if 'room_id' in val else key) %}
            {% set ns.opts = ns.opts + [name ~ ' (' ~ rid ~ ')'] %}
          {% endfor %}
        {% endif %}
        {{ ns.opts }}
  # Update the input_select with the list, or notify if empty
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ room_options | length > 0 }}"
        sequence:
          - service: input_select.set_options
            data:
              entity_id: "{{ select_ent }}"
              options: "{{ room_options }}"
          - service: persistent_notification.create
            data:
              title: "âœ… Room Update Completed"
              message: >-
                **Perfect!** Found {{ room_options | length }} rooms in map {{ map_ent }}.
                
                The rooms have been added to helper **{{ select_ent }}** and are ready to use!
                
                ðŸŽ™ï¸ **Next step**: Use the "Alexa: Room Cleaning Scripts" blueprint to create voice commands.
      # If no rooms found, send notification
      - conditions: []
        sequence:
          - service: persistent_notification.create
            data:
              title: "âš ï¸ No Rooms Found"
              message: >-
                **Warning!** No rooms were found in the `rooms` attribute of map {{ map_ent }}.
                
                ðŸ”§ **Possible solutions**:
                â€¢ Verify that the Tasshack/Dreame integration is configured correctly
                â€¢ Make sure the robot has completed at least one full mapping
                â€¢ Check that the Vacuum Map Card is configured correctly
                â€¢ Try running a full cleaning cycle to update the map
                
                ðŸ“ž **Need help?** Check the blueprint documentation on GitHub!