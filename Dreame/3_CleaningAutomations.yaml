blueprint:
  name: 🤖 [DEV 3] Dreame Vacuum - Automazione Pulizie Avanzata
  description: |
    🚀 **AUTOMAZIONE AVANZATA PER DREAME VACUUM**
    
    ✨ **CARATTERISTICHE:**
    - 🎯 Slot Principale (Mattina + Sera con logica adattiva)
    - 📅 4 Schedulazioni Aggiuntive configurabili  
    - 🏠 Controllo presenza automatico
    - 🧠 Modalità adattive (pulisci solo se necessario)
    - 🔄 Fallback automatici se già pulito
    - 🐛 Debug mode avanzato

  domain: automation
  input:
    # ═══════════════════════════════════════════════════════════════
    # 🔧 CONFIGURAZIONE BASE
    # ═══════════════════════════════════════════════════════════════
    vacuum_entity:
      name: 🤖 Entità Vacuum
      selector:
        entity:
          domain: vacuum

    robot_status_sensor:
      name: 📊 Sensore Stato Robot
      selector:
        entity:
          domain: sensor

    presence_entity:
      name: 👥 Entità Presenza
      description: Counter, input_number, sensor per rilevare presenza
      selector:
        entity: {}

    presence_value:
      name: 🏠 Valore "Casa Vuota"
      description: Valore che indica casa vuota (es. 0 per counter, 'away' per person)
      default: "0"
      selector:
        text: {}

    flag_cleaned_today:
      name: 🧹 Flag "Pulito Oggi"
      description: Input boolean che traccia se è già stato pulito oggi
      selector:
        entity:
          domain: input_boolean

    # ═══════════════════════════════════════════════════════════════
    # 🎯 SLOT PRINCIPALE
    # ═══════════════════════════════════════════════════════════════
    main_on:
      name: 🎯 SLOT PRINCIPALE - Abilita
      description: Abilita lo slot principale di pulizie
      selector:
        boolean: {}

    # ────────────────────── MATTINA ──────────────────────
    main_morning_on:
      name: 🌅 SLOT PRINCIPALE - Mattina - Abilita
      selector:
        boolean: {}

    main_morning_time:
      name: ⏰ SLOT PRINCIPALE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    main_morning_weekdays:
      name: 📅 SLOT PRINCIPALE - Mattina - Giorni
      default: ["lunedì"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    main_morning_preset:
      name: 🎯 SLOT PRINCIPALE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_morning_rooms:
      name: 🏠 SLOT PRINCIPALE - Mattina - Stanze
      description: "ID stanze separate da virgole (es: 1,2,3) o vuoto per tutta casa"
      default: ""
      selector:
        text: {}

    # ────────────────────── SERA ──────────────────────
    main_evening_on:
      name: 🌙 SLOT PRINCIPALE - Sera - Abilita
      selector:
        boolean: {}

    main_evening_time:
      name: ⏰ SLOT PRINCIPALE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    main_evening_weekdays:
      name: 📅 SLOT PRINCIPALE - Sera - Giorni
      default: ["lunedì"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    main_evening_conditional:
      name: 🧠 SLOT PRINCIPALE - Sera - Logica Adattiva
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo: modalità diversa se già pulito"
            - value: "skip_if_cleaned"  
              label: "⏭️ Salta se già pulito oggi"

    main_evening_preset:
      name: 🎯 SLOT PRINCIPALE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_evening_rooms:
      name: 🏠 SLOT PRINCIPALE - Sera - Stanze Principali
      description: "ID stanze separate da virgole (es: 1,2,3) o vuoto per tutta casa"
      default: ""
      selector:
        text: {}

    main_evening_fallback_preset:
      name: 🔄 SLOT PRINCIPALE - Sera - Modalità Alternativa
      description: "Modalità da usare se già pulito (solo se logica = adapt_if_cleaned)"
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_evening_fallback_rooms:
      name: 🏠 SLOT PRINCIPALE - Sera - Stanze Alternative
      description: "Stanze per modalità alternativa (es: solo bagno = 3)"
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 📋 PRIMA SCHEDULAZIONE AGGIUNTIVA
    # ═══════════════════════════════════════════════════════════════
    schedule1_on:
      name: 📋 PRIMA SCHEDULAZIONE - Abilita
      selector:
        boolean: {}

    schedule1_morning_on:
      name: 🌅 PRIMA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}

    schedule1_morning_time:
      name: ⏰ PRIMA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    schedule1_morning_weekdays:
      name: 📅 PRIMA SCHEDULAZIONE - Mattina - Giorni
      default: ["sabato"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule1_morning_preset:
      name: 🎯 PRIMA SCHEDULAZIONE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_morning_rooms:
      name: 🏠 PRIMA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      selector:
        text: {}

    schedule1_evening_on:
      name: 🌙 PRIMA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}

    schedule1_evening_time:
      name: ⏰ PRIMA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    schedule1_evening_weekdays:
      name: 📅 PRIMA SCHEDULAZIONE - Sera - Giorni
      default: ["sabato"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule1_evening_conditional:
      name: 🧠 PRIMA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito"

    schedule1_evening_preset:
      name: 🎯 PRIMA SCHEDULAZIONE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_evening_rooms:
      name: 🏠 PRIMA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      selector:
        text: {}

    schedule1_evening_fallback_preset:
      name: 🔄 PRIMA SCHEDULAZIONE - Sera - Modalità Alternativa
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_evening_fallback_rooms:
      name: 🏠 PRIMA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 📋 SECONDA SCHEDULAZIONE AGGIUNTIVA
    # ═══════════════════════════════════════════════════════════════
    schedule2_on:
      name: 📋 SECONDA SCHEDULAZIONE - Abilita
      selector:
        boolean: {}

    schedule2_morning_on:
      name: 🌅 SECONDA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}

    schedule2_morning_time:
      name: ⏰ SECONDA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    schedule2_morning_weekdays:
      name: 📅 SECONDA SCHEDULAZIONE - Mattina - Giorni
      default: ["domenica"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule2_morning_preset:
      name: 🎯 SECONDA SCHEDULAZIONE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_morning_rooms:
      name: 🏠 SECONDA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      selector:
        text: {}

    schedule2_evening_on:
      name: 🌙 SECONDA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}

    schedule2_evening_time:
      name: ⏰ SECONDA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    schedule2_evening_weekdays:
      name: 📅 SECONDA SCHEDULAZIONE - Sera - Giorni
      default: ["domenica"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule2_evening_conditional:
      name: 🧠 SECONDA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito"

    schedule2_evening_preset:
      name: 🎯 SECONDA SCHEDULAZIONE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_evening_rooms:
      name: 🏠 SECONDA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      selector:
        text: {}

    schedule2_evening_fallback_preset:
      name: 🔄 SECONDA SCHEDULAZIONE - Sera - Modalità Alternativa
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_evening_fallback_rooms:
      name: 🏠 SECONDA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 📋 TERZA SCHEDULAZIONE AGGIUNTIVA
    # ═══════════════════════════════════════════════════════════════
    schedule3_on:
      name: 📋 TERZA SCHEDULAZIONE - Abilita
      selector:
        boolean: {}

    schedule3_morning_on:
      name: 🌅 TERZA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}

    schedule3_morning_time:
      name: ⏰ TERZA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    schedule3_morning_weekdays:
      name: 📅 TERZA SCHEDULAZIONE - Mattina - Giorni
      default: ["sabato"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule3_morning_preset:
      name: 🎯 TERZA SCHEDULAZIONE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_morning_rooms:
      name: 🏠 TERZA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      selector:
        text: {}

    schedule3_evening_on:
      name: 🌙 TERZA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}

    schedule3_evening_time:
      name: ⏰ TERZA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    schedule3_evening_weekdays:
      name: 📅 TERZA SCHEDULAZIONE - Sera - Giorni
      default: ["sabato"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule3_evening_conditional:
      name: 🧠 TERZA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito"

    schedule3_evening_preset:
      name: 🎯 TERZA SCHEDULAZIONE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_evening_rooms:
      name: 🏠 TERZA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      selector:
        text: {}

    schedule3_evening_fallback_preset:
      name: 🔄 TERZA SCHEDULAZIONE - Sera - Modalità Alternativa
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_evening_fallback_rooms:
      name: 🏠 TERZA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 📋 QUARTA SCHEDULAZIONE AGGIUNTIVA
    # ═══════════════════════════════════════════════════════════════
    schedule4_on:
      name: 📋 QUARTA SCHEDULAZIONE - Abilita
      selector:
        boolean: {}

    schedule4_morning_on:
      name: 🌅 QUARTA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}

    schedule4_morning_time:
      name: ⏰ QUARTA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    schedule4_morning_weekdays:
      name: 📅 QUARTA SCHEDULAZIONE - Mattina - Giorni
      default: ["domenica"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule4_morning_preset:
      name: 🎯 QUARTA SCHEDULAZIONE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_morning_rooms:
      name: 🏠 QUARTA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      selector:
        text: {}

    schedule4_evening_on:
      name: 🌙 QUARTA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}

    schedule4_evening_time:
      name: ⏰ QUARTA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    schedule4_evening_weekdays:
      name: 📅 QUARTA SCHEDULAZIONE - Sera - Giorni
      default: ["domenica"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule4_evening_conditional:
      name: 🧠 QUARTA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito"

    schedule4_evening_preset:
      name: 🎯 QUARTA SCHEDULAZIONE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_evening_rooms:
      name: 🏠 QUARTA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      selector:
        text: {}

    schedule4_evening_fallback_preset:
      name: 🔄 QUARTA SCHEDULAZIONE - Sera - Modalità Alternativa
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_evening_fallback_rooms:
      name: 🏠 QUARTA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 🐛 DEBUG
    # ═══════════════════════════════════════════════════════════════
    debug_mode:
      name: 🐛 Modalità Debug
      description: Abilita log dettagliati per troubleshooting
      selector:
        boolean: {}

# ═══════════════════════════════════════════════════════════════
# 🔥 TRIGGERS & LOGIC
# ═══════════════════════════════════════════════════════════════
trigger:
  # SLOT PRINCIPALE - MATTINA
  - platform: time
    at: !input main_morning_time
    id: main_morning
    enabled: !input main_morning_on

  # SLOT PRINCIPALE - SERA
  - platform: time  
    at: !input main_evening_time
    id: main_evening
    enabled: !input main_evening_on

  # PRIMA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule1_morning_time
    id: schedule1_morning
    enabled: !input schedule1_morning_on

  # PRIMA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule1_evening_time
    id: schedule1_evening
    enabled: !input schedule1_evening_on

  # SECONDA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule2_morning_time
    id: schedule2_morning
    enabled: !input schedule2_morning_on

  # SECONDA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule2_evening_time
    id: schedule2_evening
    enabled: !input schedule2_evening_on

  # TERZA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule3_morning_time
    id: schedule3_morning
    enabled: !input schedule3_morning_on

  # TERZA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule3_evening_time
    id: schedule3_evening
    enabled: !input schedule3_evening_on

  # QUARTA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule4_morning_time
    id: schedule4_morning
    enabled: !input schedule4_morning_on

  # QUARTA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule4_evening_time
    id: schedule4_evening
    enabled: !input schedule4_evening_on

# ═══════════════════════════════════════════════════════════════
# 🛡️ CONDIZIONI GLOBALI
# ═══════════════════════════════════════════════════════════════
condition:
  - condition: and
    conditions:
      # ROBOT IN STATO VALIDO (HARDCODATO)
      - condition: template
        value_template: >
          {{ states(!input robot_status_sensor) in ['idle', 'sleeping', 'charging', 'docked'] }}
      
      # CONTROLLO PRESENZA
      - condition: template
        value_template: >
          {{ states(!input presence_entity) == !input presence_value }}
      
      # CONTROLLO GIORNO SPECIFICO PER TRIGGER
      - condition: template
        value_template: >
          {%- set current_day = now().strftime('%A') | lower -%}
          {%- set day_mapping = {
            'monday': 'lunedì', 'tuesday': 'martedì', 'wednesday': 'mercoledì',
            'thursday': 'giovedì', 'friday': 'venerdì', 'saturday': 'sabato', 'sunday': 'domenica'
          } -%}
          {%- set today_ita = day_mapping[current_day] -%}
          
          {%- if trigger.id == 'main_morning' -%}
            {{ today_ita in !input main_morning_weekdays }}
          {%- elif trigger.id == 'main_evening' -%}
            {{ today_ita in !input main_evening_weekdays }}
          {%- elif trigger.id == 'schedule1_morning' -%}
            {{ today_ita in !input schedule1_morning_weekdays }}
          {%- elif trigger.id == 'schedule1_evening' -%}
            {{ today_ita in !input schedule1_evening_weekdays }}
          {%- elif trigger.id == 'schedule2_morning' -%}
            {{ today_ita in !input schedule2_morning_weekdays }}
          {%- elif trigger.id == 'schedule2_evening' -%}
            {{ today_ita in !input schedule2_evening_weekdays }}
          {%- elif trigger.id == 'schedule3_morning' -%}
            {{ today_ita in !input schedule3_morning_weekdays }}
          {%- elif trigger.id == 'schedule3_evening' -%}
            {{ today_ita in !input schedule3_evening_weekdays }}
          {%- elif trigger.id == 'schedule4_morning' -%}
            {{ today_ita in !input schedule4_morning_weekdays }}
          {%- elif trigger.id == 'schedule4_evening' -%}
            {{ today_ita in !input schedule4_evening_weekdays }}
          {%- else -%}
            false
          {%- endif -%}

# ═══════════════════════════════════════════════════════════════
# 🚀 AZIONI
# ═══════════════════════════════════════════════════════════════
action:
  - choose:
      # ═══════════════════ SLOT PRINCIPALE MATTINA ═══════════════════
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'main_morning' }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ !input debug_mode }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "🌅 Dreame - Slot Principale Mattina"
                  message: >
                    Avvio pulizia mattutina:
                    - Modalità: {{ !input main_morning_preset }}
                    - Stanze: {{ !input main_morning_rooms if !input main_morning_rooms else 'Tutta casa' }}
                    - Orario: {{ !input main_morning_time }}
          
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: !input vacuum_entity
            data:
              segments: >
                {% if !input main_morning_rooms %}
                  {{ !input main_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: !input main_morning_preset

          - service: input_boolean.turn_on
            target:
              entity_id: !input flag_cleaned_today

      # ═══════════════════ SLOT PRINCIPALE SERA ═══════════════════
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'main_evening' }}"
        sequence:
          - variables:
              already_cleaned: "{{ states(!input flag_cleaned_today) == 'on' }}"
              conditional_mode: "{{ !input main_evening_conditional }}"
              
          - if:
              - condition: template
                value_template: "{{ !input debug_mode }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "🌙 Dreame - Slot Principale Sera"
                  message: >
                    Controllo pulizia serale:
                    - Già pulito oggi: {{ already_cleaned }}
                    - Logica: {{ conditional_mode }}
                    - Modalità primaria: {{ !input main_evening_preset }}
                    {% if conditional_mode == 'adapt_if_cleaned' %}
                    - Modalità alternativa: {{ !input main_evening_fallback_preset }}
                    {% endif %}

          - choose:
              # SALTA SE GIÀ PULITO
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ !input debug_mode }}"
                    then:
                      - service: persistent_notification.create
                        data:
                          title: "⏭️ Dreame - Pulizia Saltata"
                          message: "Pulizia serale saltata: già pulito oggi"

              # MODALITÀ ADATTIVA
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: !input vacuum_entity
                    data:
                      segments: >
                        {% if !input main_evening_fallback_rooms %}
                          {{ !input main_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: !input main_evening_fallback_preset

            # DEFAULT: PULIZIA NORMALE
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: !input vacuum_entity
                data:
                  segments: >
                    {% if !input main_evening_rooms %}
                      {{ !input main_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: !input main_evening_preset

              - service: input_boolean.turn_on
                target:
                  entity_id: !input flag_cleaned_today

      # ═══════════════════ PRIMA SCHEDULAZIONE MATTINA ═══════════════════
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule1_morning' }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ !input debug_mode }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "🌅 Dreame - Prima Schedulazione Mattina"
                  message: >
                    Avvio prima schedulazione mattutina:
                    - Modalità: {{ !input schedule1_morning_preset }}
                    - Stanze: {{ !input schedule1_morning_rooms if !input schedule1_morning_rooms else 'Tutta casa' }}
          
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: !input vacuum_entity
            data:
              segments: >
                {% if !input schedule1_morning_rooms %}
                  {{ !input schedule1_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: !input schedule1_morning_preset

          - service: input_boolean.turn_on
            target:
              entity_id: !input flag_cleaned_today

      # ═══════════════════ PRIMA SCHEDULAZIONE SERA ═══════════════════
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule1_evening' }}"
        sequence:
          - variables:
              already_cleaned: "{{ states(!input flag_cleaned_today) == 'on' }}"
              conditional_mode: "{{ !input schedule1_evening_conditional }}"
              
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ !input debug_mode }}"
                    then:
                      - service: persistent_notification.create
                        data:
                          title: "⏭️ Dreame - Prima Schedulazione Saltata"
                          message: "Prima schedulazione serale saltata: già pulito oggi"

              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: !input vacuum_entity
                    data:
                      segments: >
                        {% if !input schedule1_evening_fallback_rooms %}
                          {{ !input schedule1_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: !input schedule1_evening_fallback_preset

            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: !input vacuum_entity
                data:
                  segments: >
                    {% if !input schedule1_evening_rooms %}
                      {{ !input schedule1_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: !input schedule1_evening_preset

              - service: input_boolean.turn_on
                target:
                  entity_id: !input flag_cleaned_today

      # ═══════════════════ ALTRE SCHEDULAZIONI (2, 3, 4) ═══════════════════
      # [Le altre schedulazioni seguono la stessa logica - implementa se necessario]

    # DEFAULT FALLBACK
    default:
      - if:
          - condition: template
            value_template: "{{ !input debug_mode }}"
        then:
          - service: persistent_notification.create
            data:
              title: "❌ Dreame - Errore"
              message: >
                Trigger non riconosciuto: {{ trigger.id }}
                Controlla la configurazione del blueprint.
