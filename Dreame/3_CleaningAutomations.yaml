blueprint:
  name: 🤖 [DEV 3.0] Dreame Vacuum - Automazione Pulizie SEMPLIFICATA
  description: |
    🚀 **AUTOMAZIONE SEMPLIFICATA PER DREAME VACUUM**
    
    📅 **VISUALIZZA RIEPILOGO SCHEDULAZIONI** (clicca per espandere)
    
    Una volta creata l'automazione, **copia questo codice** e incollalo in:
    **Strumenti Sviluppatore → Template**
    
    ```
    ## 📅 IL TUO PIANO PULIZIE DREAME
    
    ### 🗓️ SLOT PRINCIPALE
    {% for day in ['lunedì', 'martedì', 'mercoledì', 'giovedì', 'venerdì', 'sabato', 'domenica'] %}
    {% if day in states.input_select.main_weekdays.state.split(',') %}
    **{{ day.title() }}:**
    {% if states('input_boolean.main_morning_on') == 'on' %}
    - 🌅 {{ states('input_datetime.main_morning_time') }} → {{ states('input_select.main_morning_preset') }}
    Stanze: {{ states('input_text.main_morning_rooms') or 'Tutta casa' }}
    {% endif %}
    {% if states('input_boolean.main_evening_on') == 'on' %}
    - 🌙 {{ states('input_datetime.main_evening_time') }} → Logica: {{ states('input_select.main_evening_conditional') }}
    {% endif %}
    {% endif %}
    {% endfor %}
    
    ### 🎯 SCHEDULAZIONI AGGIUNTIVE 
    {% for i in range(1, 5) %}
    {% if states('input_boolean.schedule' + i|string + '_on') == 'on' %}
    **Schedulazione {{ i }}:**
    [Giorni configurati: {{ states('input_select.schedule' + i|string + '_weekdays').split(',') | join(', ') }}]
    {% endif %}
    {% endfor %}
    
    ### ⚠️ ATTENZIONE
    Verifica che non ci siano sovrapposizioni di giorni tra schedulazioni diverse!
    ```
    
    **Ti mostrerà esattamente quando e dove è programmato il robot.**
    Se vedi conflitti, modifica l'automazione e ricontrolla.
    
    🤖 **Automazione semplificata per robot Dreame**
    
    ✨ **Funzionalità:**
    - 🔄 Logica adattiva (sera si adatta al mattino)
    - 🤖 Controllo stato robot prima dell'avvio
    - 🔔 Notifiche Alexa opzionali
    - 🐛 Debug completo per troubleshooting
    - ✨ **SEMPLIFICATO**: Una pulizia per slot, zero complessità
    
    🎯 **Struttura:** 1 Slot Principale + 4 Schedulazioni Aggiuntive (opzionali)
    Ogni slot ha mattina e sera configurabili separatamente.
    
    ✨ **CARATTERISTICHE:**
    - 🎯 Slot Principale (Mattina + Sera con logica adattiva)
    - 📅 4 Schedulazioni Aggiuntive configurabili con logica adattiva
    - 🏠 Controllo presenza automatico
    - 🧠 Modalità adattive (pulisci solo se necessario)
    - 🔄 Fallback automatici se già pulito
    - 🐛 Debug mode avanzato
    - 🚀 **NUOVO**: Versione semplificata senza modalità sequenziali

  domain: automation
  input:
    # ═══════════════════════════════════════════════════════════════
    # 🔧 CONFIGURAZIONE BASE
    # ═══════════════════════════════════════════════════════════════
    vacuum_entity:
      name: 🤖 Entità Vacuum
      description: Il tuo robot Dreame (es. vacuum.ambrogio)
      selector:
        entity:
          domain: vacuum

    robot_status_sensor:
      name: 📊 Sensore Stato Robot (Opzionale)
      description: |
        Sensore di stato dettagliato per controlli avanzati.
        
        🔍 **Come trovarlo:** `sensor.NOME_ROBOT_status`
        Es: `sensor.ambrogio_status` per robot `vacuum.ambrogio`
        
        ⚠️ Lascia vuoto per disabilitare controlli stato
      default: ""
      selector:
        entity:
          domain: sensor

    # ═══════════════════════════════════════════════════════════════
    # 🏠 CONTROLLO PRESENZA
    # ═══════════════════════════════════════════════════════════════
    presence_entity:
      name: 🏠 Entità Presenza (Opzionale)
      description: |
        Entità che indica se sei in casa o fuori.
        
        💡 **Esempi comuni:**
        - `person.nome` (entità Persona)
        - `binary_sensor.occupancy` (sensore PIR)
        - `counter.people_home` (contatore persone)
        
        ⚠️ Lascia vuoto per disabilitare controllo presenza
      default: ""
      selector:
        entity: {}

    presence_value:
      name: 🏠 Valore "Casa Vuota"
      description: Valore che indica casa vuota (es. 0 per counter, 'away' per person)
      default: "0"
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 🧹 FLAG PULIZIA GLOBALE
    # ═══════════════════════════════════════════════════════════════
    flag_cleaned_today:
      name: 🧹 Flag "Pulito Oggi"
      description: Input boolean che traccia se è già stato pulito oggi
      selector:
        entity:
          domain: input_boolean

    # ═══════════════════════════════════════════════════════════════
    # 🔔 NOTIFICHE E DEBUG
    # ═══════════════════════════════════════════════════════════════
    notification_targets:
      name: 🔔 Notifiche Alexa (Opzionale)
      description: |
        Media player per annunci vocali automatici.
        
        📱 **Sintassi:** `media_player.echo_soggiorno` o multipli separati da virgola
        
        ⚠️ Lascia vuoto per disabilitare
      default: ""

    debug_mode:
      name: 🐛 Modalità Debug
      description: Abilita log dettagliati per troubleshooting
      selector:
        boolean: {}

    # ═══════════════════════════════════════════════════════════════
    # 🎯 SLOT PRINCIPALE
    # ═══════════════════════════════════════════════════════════════
    main_on:
      name: 🎯 SLOT PRINCIPALE - Abilita
      description: Abilita lo slot principale di pulizie
      selector:
        boolean: {}

    # ────────────────────── MATTINA ──────────────────────
    main_morning_on:
      name: 🌅 SLOT PRINCIPALE - Mattina - Abilita
      description: Attiva pulizia mattutina per slot principale
      selector:
        boolean: {}

    main_morning_time:
      name: ⏰ SLOT PRINCIPALE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    main_morning_weekdays:
      name: 📅 SLOT PRINCIPALE - Mattina - Giorni
      description: Giorni per pulizia mattutina
      default: ["lunedì"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    main_morning_preset:
      name: 🎯 SLOT PRINCIPALE - Mattina - Modalità
      description: |
        📋 **Modalità disponibili:**
        - **aspira:** Solo aspirazione
        - **lava:** Solo lavaggio
        - **aspira_lava:** Aspirazione + lavaggio
        - **cleangenius_deep:** Pulizia approfondita
        - **spot_cleaning:** Pulizia a punti
        - **custom:** Modalità personalizzata
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_morning_rooms:
      name: 🏠 SLOT PRINCIPALE - Mattina - Stanze
      description: "ID stanze separate da virgole (es: 1,2,3) o vuoto per tutta casa"
      default: ""
      selector:
        text: {}

    # ────────────────────── SERA ──────────────────────
    main_evening_on:
      name: 🌙 SLOT PRINCIPALE - Sera - Abilita
      selector:
        boolean: {}

    main_evening_time:
      name: ⏰ SLOT PRINCIPALE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    main_evening_weekdays:
      name: 📅 SLOT PRINCIPALE - Sera - Giorni
      default: ["lunedì"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    main_evening_conditional:
      name: 🧠 SLOT PRINCIPALE - Sera - Logica Adattiva
      description: |
        **Come comportarsi in base alla pulizia mattutina:**
        
        - **Pulisci Sempre:** Ignora se già pulito (modalità classica)
        - **Salta se già pulito:** Non fa nulla se flag acceso
        - **Adattivo:** Usa modalità alternativa se già pulito
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo: modalità diversa se già pulito"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito oggi"

    main_evening_preset:
      name: 🎯 SLOT PRINCIPALE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_evening_rooms:
      name: 🏠 SLOT PRINCIPALE - Sera - Stanze Principali
      description: "ID stanze separate da virgole (es: 1,2,3) o vuoto per tutta casa"
      default: ""
      selector:
        text: {}

    main_evening_fallback_preset:
      name: 🔄 SLOT PRINCIPALE - Sera - Modalità Alternativa
      description: "Modalità da usare se già pulito (solo se logica = adapt_if_cleaned)"
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_evening_fallback_rooms:
      name: 🏠 SLOT PRINCIPALE - Sera - Stanze Alternative
      description: "Stanze per modalità alternativa (es: solo bagno = 3)"
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 📋 PRIMA SCHEDULAZIONE AGGIUNTIVA
    # ═══════════════════════════════════════════════════════════════
    schedule1_on:
      name: 📋 PRIMA SCHEDULAZIONE - Abilita
      description: Attiva la prima schedulazione aggiuntiva con logica adattiva
      selector:
        boolean: {}

    schedule1_morning_on:
      name: 🌅 PRIMA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}

    schedule1_morning_time:
      name: ⏰ PRIMA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    schedule1_morning_weekdays:
      name: 📅 PRIMA SCHEDULAZIONE - Mattina - Giorni
      default: ["sabato"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule1_morning_preset:
      name: 🎯 PRIMA SCHEDULAZIONE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_morning_rooms:
      name: 🏠 PRIMA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      selector:
        text: {}

    schedule1_evening_on:
      name: 🌙 PRIMA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}

    schedule1_evening_time:
      name: ⏰ PRIMA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    schedule1_evening_weekdays:
      name: 📅 PRIMA SCHEDULAZIONE - Sera - Giorni
      default: ["sabato"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule1_evening_conditional:
      name: 🧠 PRIMA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito"

    schedule1_evening_preset:
      name: 🎯 PRIMA SCHEDULAZIONE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_evening_rooms:
      name: 🏠 PRIMA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      selector:
        text: {}

    schedule1_evening_fallback_preset:
      name: 🔄 PRIMA SCHEDULAZIONE - Sera - Modalità Alternativa
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_evening_fallback_rooms:
      name: 🏠 PRIMA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 📋 SECONDA SCHEDULAZIONE AGGIUNTIVA
    # ═══════════════════════════════════════════════════════════════
    schedule2_on:
      name: 📋 SECONDA SCHEDULAZIONE - Abilita
      description: Attiva la seconda schedulazione aggiuntiva con logica adattiva
      selector:
        boolean: {}

    schedule2_morning_on:
      name: 🌅 SECONDA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}

    schedule2_morning_time:
      name: ⏰ SECONDA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    schedule2_morning_weekdays:
      name: 📅 SECONDA SCHEDULAZIONE - Mattina - Giorni
      default: ["domenica"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule2_morning_preset:
      name: 🎯 SECONDA SCHEDULAZIONE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_morning_rooms:
      name: 🏠 SECONDA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      selector:
        text: {}

    schedule2_evening_on:
      name: 🌙 SECONDA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}

    schedule2_evening_time:
      name: ⏰ SECONDA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    schedule2_evening_weekdays:
      name: 📅 SECONDA SCHEDULAZIONE - Sera - Giorni
      default: ["domenica"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule2_evening_conditional:
      name: 🧠 SECONDA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito"

    schedule2_evening_preset:
      name: 🎯 SECONDA SCHEDULAZIONE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_evening_rooms:
      name: 🏠 SECONDA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      selector:
        text: {}

    schedule2_evening_fallback_preset:
      name: 🔄 SECONDA SCHEDULAZIONE - Sera - Modalità Alternativa
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_evening_fallback_rooms:
      name: 🏠 SECONDA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 📋 TERZA SCHEDULAZIONE AGGIUNTIVA
    # ═══════════════════════════════════════════════════════════════
    schedule3_on:
      name: 📋 TERZA SCHEDULAZIONE - Abilita
      description: Attiva la terza schedulazione aggiuntiva con logica adattiva
      selector:
        boolean: {}

    schedule3_morning_on:
      name: 🌅 TERZA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}

    schedule3_morning_time:
      name: ⏰ TERZA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    schedule3_morning_weekdays:
      name: 📅 TERZA SCHEDULAZIONE - Mattina - Giorni
      default: ["sabato"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule3_morning_preset:
      name: 🎯 TERZA SCHEDULAZIONE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_morning_rooms:
      name: 🏠 TERZA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      selector:
        text: {}

    schedule3_evening_on:
      name: 🌙 TERZA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}

    schedule3_evening_time:
      name: ⏰ TERZA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    schedule3_evening_weekdays:
      name: 📅 TERZA SCHEDULAZIONE - Sera - Giorni
      default: ["sabato"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule3_evening_conditional:
      name: 🧠 TERZA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito"

    schedule3_evening_preset:
      name: 🎯 TERZA SCHEDULAZIONE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_evening_rooms:
      name: 🏠 TERZA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      selector:
        text: {}

    schedule3_evening_fallback_preset:
      name: 🔄 TERZA SCHEDULAZIONE - Sera - Modalità Alternativa
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_evening_fallback_rooms:
      name: 🏠 TERZA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ═══════════════════════════════════════════════════════════════
    # 📋 QUARTA SCHEDULAZIONE AGGIUNTIVA
    # ═══════════════════════════════════════════════════════════════
    schedule4_on:
      name: 📋 QUARTA SCHEDULAZIONE - Abilita
      description: Attiva la quarta schedulazione aggiuntiva con logica adattiva
      selector:
        boolean: {}

    schedule4_morning_on:
      name: 🌅 QUARTA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}

    schedule4_morning_time:
      name: ⏰ QUARTA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}

    schedule4_morning_weekdays:
      name: 📅 QUARTA SCHEDULAZIONE - Mattina - Giorni
      default: ["domenica"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule4_morning_preset:
      name: 🎯 QUARTA SCHEDULAZIONE - Mattina - Modalità
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_morning_rooms:
      name: 🏠 QUARTA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      selector:
        text: {}

    schedule4_evening_on:
      name: 🌙 QUARTA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}

    schedule4_evening_time:
      name: ⏰ QUARTA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}

    schedule4_evening_weekdays:
      name: 📅 QUARTA SCHEDULAZIONE - Sera - Giorni
      default: ["domenica"]
      selector:
        select:
          options:
            - lunedì
            - martedì
            - mercoledì
            - giovedì
            - venerdì
            - sabato
            - domenica
          multiple: true

    schedule4_evening_conditional:
      name: 🧠 QUARTA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "🔄 Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "🧠 Adattivo"
            - value: "skip_if_cleaned"
              label: "⏭️ Salta se già pulito"

    schedule4_evening_preset:
      name: 🎯 QUARTA SCHEDULAZIONE - Sera - Modalità Principale
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_evening_rooms:
      name: 🏠 QUARTA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      selector:
        text: {}

    schedule4_evening_fallback_preset:
      name: 🔄 QUARTA SCHEDULAZIONE - Sera - Modalità Alternativa
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_evening_fallback_rooms:
      name: 🏠 QUARTA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

# ═══════════════════════════════════════════════════════════════
# 🔥 TRIGGERS & LOGIC
# ═══════════════════════════════════════════════════════════════
trigger:
  # SLOT PRINCIPALE - MATTINA
  - platform: time
    at: !input main_morning_time
    id: main_morning
    enabled: !input main_morning_on
  # SLOT PRINCIPALE - SERA
  - platform: time  
    at: !input main_evening_time
    id: main_evening
    enabled: !input main_evening_on
  
  # PRIMA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule1_morning_time
    id: schedule1_morning
    enabled: !input schedule1_morning_on
  # PRIMA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule1_evening_time
    id: schedule1_evening
    enabled: !input schedule1_evening_on
  
  # SECONDA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule2_morning_time
    id: schedule2_morning
    enabled: !input schedule2_morning_on
  # SECONDA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule2_evening_time
    id: schedule2_evening
    enabled: !input schedule2_evening_on
  
  # TERZA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule3_morning_time
    id: schedule3_morning
    enabled: !input schedule3_morning_on
  # TERZA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule3_evening_time
    id: schedule3_evening
    enabled: !input schedule3_evening_on
  
  # QUARTA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule4_morning_time
    id: schedule4_morning
    enabled: !input schedule4_morning_on
  # QUARTA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule4_evening_time
    id: schedule4_evening
    enabled: !input schedule4_evening_on

# ═══════════════════════════════════════════════════════════════
# 🛡️ CONDIZIONI GLOBALI
# ═══════════════════════════════════════════════════════════════
condition:
  - condition: and
    conditions:
      # ROBOT IN STATO VALIDO (HARDCODATO - CORRETTO!)
      - condition: template
        value_template: >
          {% if robot_status_sensor != '' %}
            {{ states(robot_status_sensor) in ['idle', 'sleeping', 'charging', 'docked'] }}
          {% else %}
            true
          {% endif %}
        
      # CONTROLLO PRESENZA
      - condition: template
        value_template: >
          {% if presence_entity != '' %}
            {{ states(presence_entity) == presence_value }}
          {% else %}
            true
          {% endif %}
        
      # CONTROLLO GIORNO SPECIFICO PER TRIGGER
      - condition: template
        value_template: >
          {%- set current_day = now().strftime('%A') | lower -%}
          {%- set day_mapping = {
            'monday': 'lunedì', 'tuesday': 'martedì', 'wednesday': 'mercoledì',
            'thursday': 'giovedì', 'friday': 'venerdì', 'saturday': 'sabato', 'sunday': 'domenica'
          } -%}
          {%- set today_ita = day_mapping[current_day] -%}
          
          {%- if trigger.id == 'main_morning' -%}
            {{ main_on and today_ita in main_morning_weekdays }}
          {%- elif trigger.id == 'main_evening' -%}
            {{ main_on and today_ita in main_evening_weekdays }}
          {%- elif trigger.id == 'schedule1_morning' -%}
            {{ schedule1_on and today_ita in schedule1_morning_weekdays }}
          {%- elif trigger.id == 'schedule1_evening' -%}
            {{ schedule1_on and today_ita in schedule1_evening_weekdays }}
          {%- elif trigger.id == 'schedule2_morning' -%}
            {{ schedule2_on and today_ita in schedule2_morning_weekdays }}
          {%- elif trigger.id == 'schedule2_evening' -%}
            {{ schedule2_on and today_ita in schedule2_evening_weekdays }}
          {%- elif trigger.id == 'schedule3_morning' -%}
            {{ schedule3_on and today_ita in schedule3_morning_weekdays }}
          {%- elif trigger.id == 'schedule3_evening' -%}
            {{ schedule3_on and today_ita in schedule3_evening_weekdays }}
          {%- elif trigger.id == 'schedule4_morning' -%}
            {{ schedule4_on and today_ita in schedule4_morning_weekdays }}
          {%- elif trigger.id == 'schedule4_evening' -%}
            {{ schedule4_on and today_ita in schedule4_evening_weekdays }}
          {%- else -%}
            false
          {%- endif -%}

# ═══════════════════════════════════════════════════════════════
# 🚀 AZIONI
# ═══════════════════════════════════════════════════════════════
action:
  - choose:
    # ═══════════════════ SLOT PRINCIPALE MATTINA ═══════════════════
    - conditions:
        - condition: template
          value_template: "{{ trigger.id == 'main_morning' }}"
      sequence:
        - if:
            - condition: template
              value_template: "{{ debug_mode }}"
          then:
            - service: persistent_notification.create
              data:
                title: "🌅 Dreame - Slot Principale Mattina"
                message: >
                  Avvio pulizia mattutina:
                  - Modalità: {{ main_morning_preset }}
                  - Stanze: {{ main_morning_rooms if main_morning_rooms else 'Tutta casa' }}
                  - Orario: {{ main_morning_time }}
        
        - service: dreame_vacuum.vacuum_clean_segment
          target:
            entity_id: !input vacuum_entity
          data:
            segments: >
              {% if main_morning_rooms %}
                {{ main_morning_rooms.split(',') | map('int') | list }}
              {% else %}
                []
              {% endif %}
            cleaning_mode: !input main_morning_preset
        
        - service: input_boolean.turn_on
          target:
            entity_id: !input flag_cleaned_today

    # ═══════════════════ SLOT PRINCIPALE SERA ═══════════════════
    - conditions:
        - condition: template
          value_template: "{{ trigger.id == 'main_evening' }}"
      sequence:
        - variables:
            already_cleaned: "{{ states(flag_cleaned_today) == 'on' }}"
            conditional_mode: "{{ main_evening_conditional }}"
        
        - if:
            - condition: template
              value_template: "{{ debug_mode }}"
          then:
            - service: persistent_notification.create
              data:
                title: "🌙 Dreame - Slot Principale Sera"
                message: >
                  Controllo pulizia serale:
                  - Già pulito oggi: {{ already_cleaned }}
                  - Logica: {{ conditional_mode }}
                  - Modalità primaria: {{ main_evening_preset }}
                  {% if conditional_mode == 'adapt_if_cleaned' %}
                  - Modalità alternativa: {{ main_evening_fallback_preset }}
                  {% endif %}
        
        - choose:
            # SALTA SE GIÀ PULITO
            - conditions:
                - condition: template
                  value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
              sequence:
                - if:
                    - condition: template
                      value_template: "{{ debug_mode }}"
                  then:
                    - service: persistent_notification.create
                      data:
                        title: "⏭️ Dreame - Pulizia Saltata"
                        message: "Pulizia serale saltata: già pulito oggi"
                - stop: "Pulizia già effettuata oggi"
            
            # MODALITÀ ADATTIVA
            - conditions:
                - condition: template
                  value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
              sequence:
                - service: dreame_vacuum.vacuum_clean_segment
                  target:
                    entity_id: !input vacuum_entity
                  data:
                    segments: >
                      {% if main_evening_fallback_rooms %}
                        {{ main_evening_fallback_rooms.split(',') | map('int') | list }}
                      {% else %}
                        []
                      {% endif %}
                    cleaning_mode: !input main_evening_fallback_preset
            
            # DEFAULT: PULIZIA NORMALE
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: !input vacuum_entity
                data:
                  segments: >
                    {% if main_evening_rooms %}
                      {{ main_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: !input main_evening_preset
        
        - service: input_boolean.turn_on
          target:
            entity_id: !input flag_cleaned_today

    # ═══════════════════ PRIMA SCHEDULAZIONE MATTINA ═══════════════════
    - conditions:
        - condition: template
          value_template: "{{ trigger.id == 'schedule1_morning' }}"
      sequence:
        - if:
            - condition: template
              value_template: "{{ debug_mode }}"
          then:
            - service: persistent_notification.create
              data:
                title: "🌅 Dreame - Prima Schedulazione Mattina"
                message: >
                  Avvio prima schedulazione mattutina:
                  - Modalità: {{ schedule1_morning_preset }}
                  - Stanze: {{ schedule1_morning_rooms if schedule1_morning_rooms else 'Tutta casa' }}
        
        - service: dreame_vacuum.vacuum_clean_segment
          target:
            entity_id: !input vacuum_entity
          data:
            segments: >
              {% if schedule1_morning_rooms %}
                {{ schedule1_morning_rooms.split(',') | map('int') | list }}
              {% else %}
                []
              {% endif %}
            cleaning_mode: !input schedule1_morning_preset
        
        - service: input_boolean.turn_on
          target:
            entity_id: !input flag_cleaned_today

    # ═══════════════════ PRIMA SCHEDULAZIONE SERA ═══════════════════
    - conditions:
        - condition: template
          value_template: "{{ trigger.id == 'schedule1_evening' }}"
      sequence:
        - variables:
            already_cleaned: "{{ states(flag_cleaned_today) == 'on' }}"
            conditional_mode: "{{ schedule1_evening_conditional }}"
        
        - choose:
            # SALTA SE GIÀ PULITO
            - conditions:
                - condition: template
                  value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
              sequence:
                - if:
                    - condition: template
                      value_template: "{{ debug_mode }}"
                  then:
                    - service: persistent_notification.create
                      data:
                        title: "⏭️ Dreame - Prima Schedulazione Saltata"
                        message: "Prima schedulazione serale saltata: già pulito oggi"
                - stop: "Pulizia già effettuata oggi"
            
            # MODALITÀ ADATTIVA
            - conditions:
                - condition: template
                  value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
              sequence:
                - service: dreame_vacuum.vacuum_clean_segment
                  target:
                    entity_id: !input vacuum_entity
                  data:
                    segments: >
                      {% if schedule1_evening_fallback_rooms %}
                        {{ schedule1_evening_fallback_rooms.split(',') | map('int') | list }}
                      {% else %}
                        []
                      {% endif %}
                    cleaning_mode: !input schedule1_evening_fallback_preset
            
            # DEFAULT: PULIZIA NORMALE
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: !input vacuum_entity
                data:
                  segments: >
                    {% if schedule1_evening_rooms %}
                      {{ schedule1_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: !input schedule1_evening_preset
        
        - service: input_boolean.turn_on
          target:
            entity_id: !input flag_cleaned_today

    # ═══════════════════ ALTRE SCHEDULAZIONI (2, 3, 4) ═══════════════════
    # [Le altre schedulazioni seguono la stessa logica - implementa se necessario]

    # DEFAULT FALLBACK
    default:
      - if:
          - condition: template
            value_template: "{{ debug_mode }}"
        then:
          - service: persistent_notification.create
            data:
              title: "❌ Dreame - Errore"
              message: >
                Trigger non riconosciuto: {{ trigger.id }}
                Controlla la configurazione del blueprint.

mode: single
max_exceeded: silent
