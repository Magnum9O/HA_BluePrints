blueprint:
  name: "[DEV 2.1] Dreame Vacuum - Automazione Pulizie Avanzata"
  name: ğŸ¤– [DEV 3] Dreame Vacuum - Automazione Pulizie Avanzata
  description: |
    <details>
    <summary>ğŸ“… <strong>VISUALIZZA RIEPILOGO SCHEDULAZIONI</strong> (clicca per espandere)</summary>
    ğŸš€ **AUTOMAZIONE AVANZATA PER DREAME VACUUM**
    
    Una volta creata l'automazione, **copia questo codice** e incollalo in:
    **Strumenti Sviluppatore â†’ Template**
    
    ```
    ## ğŸ“… IL TUO PIANO PULIZIE DREAME
    
    ### ğŸ—“ï¸ SLOT PRINCIPALE
    {% for day in ['lunedÃ¬', 'martedÃ¬', 'mercoledÃ¬', 'giovedÃ¬', 'venerdÃ¬', 'sabato', 'domenica'] %}
    {% if day in states.input_select.main_weekdays.state.split(',') %}
    **{{ day.title() }}:**
    {% if states('input_boolean.main_morning_on') == 'on' %}
    - ğŸŒ… {{ states('input_datetime.main_morning_time') }} â†’ {{ states('input_select.main_morning_preset') }}
      Stanze: {{ states('input_text.main_morning_rooms') or 'Tutta casa' }}
    {% endif %}
    {% if states('input_boolean.main_evening_on') == 'on' %}
    - ğŸŒ™ {{ states('input_datetime.main_evening_time') }} â†’ Logica: {{ states('input_select.main_evening_conditional') }}
    {% endif %}
    {% endif %}
    {% endfor %}
    
    ### ğŸ¯ SCHEDULAZIONI AGGIUNTIVE  
    {% for i in range(1, 5) %}
    {% if states('input_boolean.schedule' + i|string + '_on') == 'on' %}
    **Schedulazione {{ i }}:**
    [Giorni configurati: {{ states('input_select.schedule' + i|string + '_weekdays').split(',') | join(', ') }}]
    {% endif %}
    {% endfor %}
    
    ### âš ï¸ ATTENZIONE
    Verifica che non ci siano sovrapposizioni di giorni tra schedulazioni diverse!
    ```
    
    **Ti mostrerÃ  esattamente quando e dove Ã¨ programmato il robot.**
    Se vedi conflitti, modifica l'automazione e ricontrolla.
    
    </details>
    
    ğŸ¤– **Automazione avanzata per robot Dreame**
    
    âœ¨ **FunzionalitÃ  avanzate:**
    - ğŸ”„ Logica adattiva (sera si adatta al mattino)
    - ğŸ”— Pulizie sequenziali con attesa automatica
    - ğŸ¤– Controllo stato robot prima dell'avvio
    - ğŸ”” Notifiche Alexa opzionali
    - ğŸ› Debug completo per troubleshooting
    
    ğŸ¯ **Struttura:** 1 Slot Principale + 4 Schedulazioni Aggiuntive (opzionali)
    Ogni slot ha mattina e sera configurabili separatamente.
  
    âœ¨ **CARATTERISTICHE:**
    - ğŸ¯ Slot Principale (Mattina + Sera con logica adattiva)
    - ğŸ“… 4 Schedulazioni Aggiuntive configurabili  
    - ğŸ  Controllo presenza automatico
    - ğŸ§  ModalitÃ  adattive (pulisci solo se necessario)
    - ğŸ”„ Fallback automatici se giÃ  pulito
    - ğŸ› Debug mode avanzato
  domain: automation
  input:
    # ========================================
    # === ENTITÃ€ PRINCIPALI ===
    # ========================================
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ”§ CONFIGURAZIONE BASE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    vacuum_entity:
      name: ğŸ¤– EntitÃ  Vacuum
      description: Il tuo robot Dreame (es. vacuum.ambrogio)
      selector:
        entity:
          domain: vacuum
          
    robot_status_sensor:
      name: ğŸ“Š Sensore Stato Robot (Opzionale)
      description: |
        Sensore di stato dettagliato per controlli avanzati.
        
        ğŸ” **Come trovarlo:** `sensor.NOME_ROBOT_status`
        Es: `sensor.ambrogio_status` per robot `vacuum.ambrogio`
        
        âš ï¸ Lascia vuoto per disabilitare controlli stato
      default: ""
      name: ğŸ“Š Sensore Stato Robot
      selector:
        entity:
          domain: sensor
          
    valid_robot_states:
      name: âœ… Stati Robot Validi
      description: Stati in cui il robot puÃ² avviare una pulizia
      default: ["idle", "sleeping", "charging", "docked"]
      selector:
        select:
          options:
            - "idle"
            - "sleeping" 
            - "charging"
            - "docked"
            - "paused"
            - "returning"
          multiple: true
          
    # ========================================
    # === CONTROLLO PRESENZA ===
    # ========================================
    presence_entity:
      name: ğŸ  EntitÃ  Presenza (Opzionale)
      description: |
        EntitÃ  che indica se sei in casa o fuori.
        
        ğŸ’¡ **Esempi comuni:**
        - `person.nome` (entitÃ  Persona)
        - `binary_sensor.occupancy` (sensore PIR)
        - `counter.people_home` (contatore persone)
        
        âš ï¸ Lascia vuoto per disabilitare controllo presenza
      default: ""
      name: ğŸ‘¥ EntitÃ  Presenza
      description: Counter, input_number, sensor per rilevare presenza
      selector:
        entity: {}
        
    presence_value:
      name: ğŸšª Valore "Fuori Casa"
      description: |
        Valore che indica "nessuno in casa".
        
        ğŸ“ **Esempi:** `not_home`, `away`, `off`, `0`
        
        ğŸ’¡ **Come scoprirlo:** Strumenti Sviluppatore â†’ Stati â†’ cerca la tua entitÃ  quando sei fuori
      default: "not_home"
      
    # ========================================
    # === FLAG PULIZIA GLOBALE ===
    # ========================================
      name: ğŸ  Valore "Casa Vuota"
      description: Valore che indica casa vuota (es. 0 per counter, 'away' per person)
      default: "0"
      selector:
        text: {}
    flag_cleaned_today:
      name: ğŸƒ Flag "Pulito Oggi"
      description: |
        Input boolean GLOBALE per tracciare pulizie giornaliere.
        
        ğŸ†• **DEVI CREARLO:**
        Impostazioni â†’ Dispositivi e Servizi â†’ Helper â†’ Crea Helper â†’ Interruttore
        Nome: "Robot Pulito Oggi"
        
        â„¹ï¸ **Funzione:** Evita doppie pulizie e abilita logica adattiva sera
      name: ğŸ§¹ Flag "Pulito Oggi"
      description: Input boolean che traccia se Ã¨ giÃ  stato pulito oggi
      selector:
        entity:
          domain: input_boolean
          
    # ========================================
    # === NOTIFICHE E DEBUG ===
    # ========================================
    notification_targets:
      name: ğŸ”” Notifiche Alexa (Opzionale)
      description: |
        Media player per annunci vocali automatici.
        
        ğŸ“± **Sintassi:** `media_player.echo_soggiorno` o multipli separati da virgola
        
        âš ï¸ Lascia vuoto per disabilitare
      default: ""

    debug_mode:
      name: ğŸ› ModalitÃ  Debug
      description: |
        Log dettagliati per troubleshooting.
        
        ğŸ“ **Visualizza log in:** Impostazioni â†’ Sistema â†’ Log
      default: false
      selector:
        boolean: {}
        
    # ========================================
    # === SLOT PRINCIPALE ===
    # ========================================
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ¯ SLOT PRINCIPALE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    main_on:
      name: ğŸ¯ SLOT PRINCIPALE - Abilita
      description: Slot sempre disponibile per pulizie principali (es. giorni lavorativi)
      default: true
      description: Abilita lo slot principale di pulizie
      selector:
        boolean: {}
        
    # === MATTINA SLOT PRINCIPALE ===
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MATTINA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    main_morning_on:
      name: ğŸŒ… SLOT PRINCIPALE - Mattina - Abilita
      description: Attiva pulizia mattutina per slot principale
      default: true
      selector:
        boolean: {}
        
    main_morning_time:
      name: â° SLOT PRINCIPALE - Mattina - Orario
      default: "08:00:00"
      default: "05:00:00"
      selector:
        time: {}
        
    main_morning_weekdays:
      name: ğŸ“… SLOT PRINCIPALE - Mattina - Giorni
      description: Giorni per pulizia mattutina
      default: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬"]
      default: ["lunedÃ¬"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    main_morning_preset:
      name: ğŸ¯ SLOT PRINCIPALE - Mattina - ModalitÃ 
      description: |
        ğŸ“‹ **ModalitÃ  disponibili:**
        - **aspira:** Solo aspirazione
        - **lava:** Solo lavaggio
        - **pulisci:** Aspirazione + lavaggio
        - **cleangenius:** ModalitÃ  intelligente
        - **cleangenius_deep:** Pulizia approfondita
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    main_morning_rooms:
      name: ğŸ  SLOT PRINCIPALE - Mattina - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
        
        ğŸ“ **Esempi:** `2,3,4` oppure `cucina,soggiorno`
      description: "ID stanze separate da virgole (es: 1,2,3) o vuoto per tutta casa"
      default: ""
      
    # === SERA SLOT PRINCIPALE ===
      selector:
        text: {}
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    main_evening_on:
      name: ğŸŒ™ SLOT PRINCIPALE - Sera - Abilita
      default: true
      selector:
        boolean: {}
        
    main_evening_time:
      name: â° SLOT PRINCIPALE - Sera - Orario
      default: "18:00:00"
      default: "23:00:00"
      selector:
        time: {}
        
    main_evening_weekdays:
      name: ğŸ“… SLOT PRINCIPALE - Sera - Giorni
      default: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
      default: ["lunedÃ¬"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    main_evening_conditional:
      name: ğŸ§  SLOT PRINCIPALE - Sera - Logica Adattiva
      description: |
        **Come comportarsi in base alla pulizia mattutina:**
        
        - **Esegui sempre:** Ignora se giÃ  pulito (modalitÃ  classica)
        - **Salta se giÃ  pulito:** Non fa nulla se flag acceso
        - **Solo se non pulito:** Pulizia di recupero
        - **Adatta modalitÃ :** Usa modalitÃ  alternativa se giÃ  pulito
      default: "always"
      default: "always_clean"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se giÃ  pulito"
              value: "skip_if_cleaned"
            - label: "Solo se non pulito"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalitÃ  se giÃ  pulito"
              value: "adapt_if_cleaned"
              
            - value: "always_clean"
              label: "ğŸ”„ Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "ğŸ§  Adattivo: modalitÃ  diversa se giÃ  pulito"
            - value: "skip_if_cleaned"  
              label: "â­ï¸ Salta se giÃ  pulito oggi"
    main_evening_preset:
      name: ğŸ¯ SLOT PRINCIPALE - Sera - ModalitÃ  Normale
      description: |
        ModalitÃ  per pulizia serale normale.
        
        âš ï¸ **Ignorata se sopra hai scelto "Adatta modalitÃ "**
      default: "cleangenius"
      name: ğŸ¯ SLOT PRINCIPALE - Sera - ModalitÃ  Principale
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    main_evening_rooms:
      name: ğŸ  SLOT PRINCIPALE - Sera - Stanze Normali
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  SLOT PRINCIPALE - Sera - Stanze Principali
      description: "ID stanze separate da virgole (es: 1,2,3) o vuoto per tutta casa"
      default: ""
      
      selector:
        text: {}
    main_evening_fallback_preset:
      name: ğŸ”„ SLOT PRINCIPALE - Sera - ModalitÃ  Alternativa
      description: |
        **ModalitÃ  quando giÃ  pulito** (solo se sopra = "Adatta modalitÃ ")
        
        ğŸ’¡ Es: Se mattina CleanGenius, sera solo Aspirazione
      default: "aspira"
      description: "ModalitÃ  da usare se giÃ  pulito (solo se logica = adapt_if_cleaned)"
      default: "lava"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    main_evening_fallback_rooms:
      name: ğŸ”„ SLOT PRINCIPALE - Sera - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
        
        ğŸ’¡ Es: Se mattina tutta casa, sera solo cucina
      default: ""
      
    # === SEQUENZIALI SLOT PRINCIPALE ===
    main_morning_sequential:
      name: ğŸ”— SLOT PRINCIPALE - Mattina - Pulizia Sequenziale
      description: |
        **Pulizie consecutive con attesa automatica.**
        
        ğŸ’¡ Es: Step 1 aspira soggiorno â†’ attende â†’ Step 2 pulisce cucina
      default: false
      selector:
        boolean: {}
        
    main_morning_step2_preset:
      name: ğŸ¯ SLOT PRINCIPALE - Mattina - Step 2 - ModalitÃ 
      description: Eseguito dopo completamento Step 1 (se sequenziale attivo)
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    main_morning_step2_rooms:
      name: ğŸ  SLOT PRINCIPALE - Mattina - Step 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  SLOT PRINCIPALE - Sera - Stanze Alternative
      description: "Stanze per modalitÃ  alternativa (es: solo bagno = 3)"
      default: ""
      
    main_morning_step3_preset:
      name: ğŸ¯ SLOT PRINCIPALE - Mattina - Step 3 - ModalitÃ 
      description: Eseguito dopo completamento Step 2 (se configurato)
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    main_morning_step3_rooms:
      name: ğŸ  SLOT PRINCIPALE - Mattina - Step 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      default: ""
      
    main_morning_max_wait:
      name: â±ï¸ SLOT PRINCIPALE - Mattina - Timeout Attesa (minuti)
      description: |
        Tempo massimo attesa tra step sequenziali.
        
        ğŸ’¡ Consigliato: 60-90 min per pulizie complete, 30-45 per leggere
      default: 60
      selector:
        number:
          min: 10
          max: 180
          unit_of_measurement: "min"
          
    main_evening_sequential:
      name: ğŸ”— SLOT PRINCIPALE - Sera - Pulizia Sequenziale
      description: Pulizie consecutive con attesa automatica
      default: false
      selector:
        boolean: {}
        
    main_evening_step2_preset:
      name: ğŸ¯ SLOT PRINCIPALE - Sera - Step 2 - ModalitÃ 
      default: "cleangenius"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    main_evening_step2_rooms:
      name: ğŸ  SLOT PRINCIPALE - Sera - Step 2 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      default: ""
      
    main_evening_step3_preset:
      name: ğŸ¯ SLOT PRINCIPALE - Sera - Step 3 - ModalitÃ 
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
    main_evening_step3_rooms:
      name: ğŸ  SLOT PRINCIPALE - Sera - Step 3 - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      default: ""
      
    main_evening_max_wait:
      name: â±ï¸ SLOT PRINCIPALE - Sera - Timeout Attesa (minuti)
      default: 60
      selector:
        number:
          min: 10
          max: 180
          unit_of_measurement: "min"
          
    # ========================================
    # === PRIMA SCHEDULAZIONE AGGIUNTIVA ===
    # ========================================
        text: {}
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“‹ PRIMA SCHEDULAZIONE AGGIUNTIVA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    schedule1_on:
      name: ğŸ¯ Prima Schedulazione Aggiuntiva - Abilita
      description: |
        Schedulazione opzionale per giorni/orari specifici.
        
        ğŸ’¡ **Utile per:** Weekend, pulizie approfondite, orari particolari
      default: false
      name: ğŸ“‹ PRIMA SCHEDULAZIONE - Abilita
      selector:
        boolean: {}
        
    # === MATTINA PRIMA SCHEDULAZIONE ===
    schedule1_morning_on:
      name: ğŸŒ… Prima Schedulazione - Mattina - Abilita
      default: false
      name: ğŸŒ… PRIMA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}
        
    schedule1_morning_time:
      name: â° Prima Schedulazione - Mattina - Orario
      default: "10:00:00"
      name: â° PRIMA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}
        
    schedule1_morning_weekdays:
      name: ğŸ“… Prima Schedulazione - Mattina - Giorni
      description: |
        âš ï¸ **ATTENZIONE:** Scegli giorni diversi dallo Slot Principale per evitare conflitti
      name: ğŸ“… PRIMA SCHEDULAZIONE - Mattina - Giorni
      default: ["sabato"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    schedule1_morning_preset:
      name: ğŸ¯ Prima Schedulazione - Mattina - ModalitÃ 
      default: "cleangenius"
      name: ğŸ¯ PRIMA SCHEDULAZIONE - Mattina - ModalitÃ 
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule1_morning_rooms:
      name: ğŸ  Prima Schedulazione - Mattina - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  PRIMA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      
    # === SERA PRIMA SCHEDULAZIONE ===
      selector:
        text: {}
    schedule1_evening_on:
      name: ğŸŒ™ Prima Schedulazione - Sera - Abilita
      default: false
      name: ğŸŒ™ PRIMA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}
        
    schedule1_evening_time:
      name: â° Prima Schedulazione - Sera - Orario
      default: "20:00:00"
      name: â° PRIMA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}
        
    schedule1_evening_weekdays:
      name: ğŸ“… Prima Schedulazione - Sera - Giorni
      name: ğŸ“… PRIMA SCHEDULAZIONE - Sera - Giorni
      default: ["sabato"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    schedule1_evening_conditional:
      name: ğŸ§  Prima Schedulazione - Sera - Logica Adattiva
      description: Come comportarsi in base alla mattina di QUESTA schedulazione
      default: "always"
      name: ğŸ§  PRIMA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se giÃ  pulito"
              value: "skip_if_cleaned"
            - label: "Solo se non pulito"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalitÃ  se giÃ  pulito"
              value: "adapt_if_cleaned"
              
            - value: "always_clean"
              label: "ğŸ”„ Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "ğŸ§  Adattivo"
            - value: "skip_if_cleaned"
              label: "â­ï¸ Salta se giÃ  pulito"
    schedule1_evening_preset:
      name: ğŸ¯ Prima Schedulazione - Sera - ModalitÃ  Normale
      description: ModalitÃ  normale (ignorata se sopra = "Adatta modalitÃ ")
      default: "pulisci"
      name: ğŸ¯ PRIMA SCHEDULAZIONE - Sera - ModalitÃ  Principale
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule1_evening_rooms:
      name: ğŸ  Prima Schedulazione - Sera - Stanze Normali
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  PRIMA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      
      selector:
        text: {}
    schedule1_evening_fallback_preset:
      name: ğŸ”„ Prima Schedulazione - Sera - ModalitÃ  Alternativa
      description: Usata solo se sopra = "Adatta modalitÃ  se giÃ  pulito"
      default: "aspira"
      name: ğŸ”„ PRIMA SCHEDULAZIONE - Sera - ModalitÃ  Alternativa
      default: "lava"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule1_evening_fallback_rooms:
      name: ğŸ”„ Prima Schedulazione - Sera - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  PRIMA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ========================================
    # === SECONDA SCHEDULAZIONE AGGIUNTIVA ===
    # ========================================
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“‹ SECONDA SCHEDULAZIONE AGGIUNTIVA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    schedule2_on:
      name: ğŸ¯ Seconda Schedulazione Aggiuntiva - Abilita
      default: false
      name: ğŸ“‹ SECONDA SCHEDULAZIONE - Abilita
      selector:
        boolean: {}
        
    schedule2_morning_on:
      name: ğŸŒ… Seconda Schedulazione - Mattina - Abilita
      default: false
      name: ğŸŒ… SECONDA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}
        
    schedule2_morning_time:
      name: â° Seconda Schedulazione - Mattina - Orario
      default: "11:00:00"
      name: â° SECONDA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}
        
    schedule2_morning_weekdays:
      name: ğŸ“… Seconda Schedulazione - Mattina - Giorni
      name: ğŸ“… SECONDA SCHEDULAZIONE - Mattina - Giorni
      default: ["domenica"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    schedule2_morning_preset:
      name: ğŸ¯ Seconda Schedulazione - Mattina - ModalitÃ 
      default: "cleangenius_deep"
      name: ğŸ¯ SECONDA SCHEDULAZIONE - Mattina - ModalitÃ 
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule2_morning_rooms:
      name: ğŸ  Seconda Schedulazione - Mattina - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  SECONDA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      
      selector:
        text: {}
    schedule2_evening_on:
      name: ğŸŒ™ Seconda Schedulazione - Sera - Abilita
      default: false
      name: ğŸŒ™ SECONDA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}
        
    schedule2_evening_time:
      name: â° Seconda Schedulazione - Sera - Orario
      default: "21:00:00"
      name: â° SECONDA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}
        
    schedule2_evening_weekdays:
      name: ğŸ“… Seconda Schedulazione - Sera - Giorni
      name: ğŸ“… SECONDA SCHEDULAZIONE - Sera - Giorni
      default: ["domenica"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    schedule2_evening_conditional:
      name: ğŸ§  Seconda Schedulazione - Sera - Logica Adattiva
      default: "always"
      name: ğŸ§  SECONDA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se giÃ  pulito"
              value: "skip_if_cleaned"
            - label: "Solo se non pulito"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalitÃ  se giÃ  pulito"
              value: "adapt_if_cleaned"
              
            - value: "always_clean"
              label: "ğŸ”„ Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "ğŸ§  Adattivo"
            - value: "skip_if_cleaned"
              label: "â­ï¸ Salta se giÃ  pulito"
    schedule2_evening_preset:
      name: ğŸ¯ Seconda Schedulazione - Sera - ModalitÃ  Normale
      default: "lava"
      name: ğŸ¯ SECONDA SCHEDULAZIONE - Sera - ModalitÃ  Principale
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule2_evening_rooms:
      name: ğŸ  Seconda Schedulazione - Sera - Stanze Normali
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  SECONDA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      
      selector:
        text: {}
    schedule2_evening_fallback_preset:
      name: ğŸ”„ Seconda Schedulazione - Sera - ModalitÃ  Alternativa
      default: "aspira"
      name: ğŸ”„ SECONDA SCHEDULAZIONE - Sera - ModalitÃ  Alternativa
      default: "lava"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule2_evening_fallback_rooms:
      name: ğŸ”„ Seconda Schedulazione - Sera - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  SECONDA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ========================================
    # === TERZA SCHEDULAZIONE AGGIUNTIVA ===
    # ========================================
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“‹ TERZA SCHEDULAZIONE AGGIUNTIVA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    schedule3_on:
      name: ğŸ¯ Terza Schedulazione Aggiuntiva - Abilita
      default: false
      name: ğŸ“‹ TERZA SCHEDULAZIONE - Abilita
      selector:
        boolean: {}
        
    schedule3_morning_on:
      name: ğŸŒ… Terza Schedulazione - Mattina - Abilita
      default: false
      name: ğŸŒ… TERZA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}
        
    schedule3_morning_time:
      name: â° Terza Schedulazione - Mattina - Orario
      default: "09:30:00"
      name: â° TERZA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}
        
    schedule3_morning_weekdays:
      name: ğŸ“… Terza Schedulazione - Mattina - Giorni
      name: ğŸ“… TERZA SCHEDULAZIONE - Mattina - Giorni
      default: ["sabato"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    schedule3_morning_preset:
      name: ğŸ¯ Terza Schedulazione - Mattina - ModalitÃ 
      name: ğŸ¯ TERZA SCHEDULAZIONE - Mattina - ModalitÃ 
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule3_morning_rooms:
      name: ğŸ  Terza Schedulazione - Mattina - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  TERZA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      
      selector:
        text: {}
    schedule3_evening_on:
      name: ğŸŒ™ Terza Schedulazione - Sera - Abilita
      default: false
      name: ğŸŒ™ TERZA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}
        
    schedule3_evening_time:
      name: â° Terza Schedulazione - Sera - Orario
      default: "19:30:00"
      name: â° TERZA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}
        
    schedule3_evening_weekdays:
      name: ğŸ“… Terza Schedulazione - Sera - Giorni
      name: ğŸ“… TERZA SCHEDULAZIONE - Sera - Giorni
      default: ["sabato"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    schedule3_evening_conditional:
      name: ğŸ§  Terza Schedulazione - Sera - Logica Adattiva
      default: "always"
      name: ğŸ§  TERZA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se giÃ  pulito"
              value: "skip_if_cleaned"
            - label: "Solo se non pulito"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalitÃ  se giÃ  pulito"
              value: "adapt_if_cleaned"
              
            - value: "always_clean"
              label: "ğŸ”„ Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "ğŸ§  Adattivo"
            - value: "skip_if_cleaned"
              label: "â­ï¸ Salta se giÃ  pulito"
    schedule3_evening_preset:
      name: ğŸ¯ Terza Schedulazione - Sera - ModalitÃ  Normale
      default: "cleangenius"
      name: ğŸ¯ TERZA SCHEDULAZIONE - Sera - ModalitÃ  Principale
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule3_evening_rooms:
      name: ğŸ  Terza Schedulazione - Sera - Stanze Normali
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  TERZA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      
      selector:
        text: {}
    schedule3_evening_fallback_preset:
      name: ğŸ”„ Terza Schedulazione - Sera - ModalitÃ  Alternativa
      default: "aspira"
      name: ğŸ”„ TERZA SCHEDULAZIONE - Sera - ModalitÃ  Alternativa
      default: "lava"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule3_evening_fallback_rooms:
      name: ğŸ”„ Terza Schedulazione - Sera - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  TERZA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

    # ========================================
    # === QUARTA SCHEDULAZIONE AGGIUNTIVA ===
    # ========================================
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“‹ QUARTA SCHEDULAZIONE AGGIUNTIVA
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    schedule4_on:
      name: ğŸ¯ Quarta Schedulazione Aggiuntiva - Abilita
      default: false
      name: ğŸ“‹ QUARTA SCHEDULAZIONE - Abilita
      selector:
        boolean: {}
        
    schedule4_morning_on:
      name: ğŸŒ… Quarta Schedulazione - Mattina - Abilita
      default: false
      name: ğŸŒ… QUARTA SCHEDULAZIONE - Mattina - Abilita
      selector:
        boolean: {}
        
    schedule4_morning_time:
      name: â° Quarta Schedulazione - Mattina - Orario
      default: "07:30:00"
      name: â° QUARTA SCHEDULAZIONE - Mattina - Orario
      default: "05:00:00"
      selector:
        time: {}
        
    schedule4_morning_weekdays:
      name: ğŸ“… Quarta Schedulazione - Mattina - Giorni
      name: ğŸ“… QUARTA SCHEDULAZIONE - Mattina - Giorni
      default: ["domenica"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    schedule4_morning_preset:
      name: ğŸ¯ Quarta Schedulazione - Mattina - ModalitÃ 
      default: "lava"
      name: ğŸ¯ QUARTA SCHEDULAZIONE - Mattina - ModalitÃ 
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule4_morning_rooms:
      name: ğŸ  Quarta Schedulazione - Mattina - Stanze
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  QUARTA SCHEDULAZIONE - Mattina - Stanze
      default: ""
      
      selector:
        text: {}
    schedule4_evening_on:
      name: ğŸŒ™ Quarta Schedulazione - Sera - Abilita
      default: false
      name: ğŸŒ™ QUARTA SCHEDULAZIONE - Sera - Abilita
      selector:
        boolean: {}
        
    schedule4_evening_time:
      name: â° Quarta Schedulazione - Sera - Orario
      default: "22:00:00"
      name: â° QUARTA SCHEDULAZIONE - Sera - Orario
      default: "23:00:00"
      selector:
        time: {}
        
    schedule4_evening_weekdays:
      name: ğŸ“… Quarta Schedulazione - Sera - Giorni
      name: ğŸ“… QUARTA SCHEDULAZIONE - Sera - Giorni
      default: ["domenica"]
      selector:
        select:
          options: ["lunedÃ¬", "martedÃ¬", "mercoledÃ¬", "giovedÃ¬", "venerdÃ¬", "sabato", "domenica"]
          options:
            - lunedÃ¬
            - martedÃ¬
            - mercoledÃ¬
            - giovedÃ¬
            - venerdÃ¬
            - sabato
            - domenica
          multiple: true
      
    schedule4_evening_conditional:
      name: ğŸ§  Quarta Schedulazione - Sera - Logica Adattiva
      default: "always"
      name: ğŸ§  QUARTA SCHEDULAZIONE - Sera - Logica
      default: "always_clean"
      selector:
        select:
          options:
            - label: "Esegui sempre"
              value: "always"
            - label: "Salta se giÃ  pulito"
              value: "skip_if_cleaned"
            - label: "Solo se non pulito"
              value: "fallback_if_not_cleaned"
            - label: "Adatta modalitÃ  se giÃ  pulito"
              value: "adapt_if_cleaned"
              
            - value: "always_clean"
              label: "ğŸ”„ Pulisci Sempre"
            - value: "adapt_if_cleaned"
              label: "ğŸ§  Adattivo"
            - value: "skip_if_cleaned"
              label: "â­ï¸ Salta se giÃ  pulito"
    schedule4_evening_preset:
      name: ğŸ¯ Quarta Schedulazione - Sera - ModalitÃ  Normale
      default: "pulisci"
      name: ğŸ¯ QUARTA SCHEDULAZIONE - Sera - ModalitÃ  Principale
      default: "aspira"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule4_evening_rooms:
      name: ğŸ  Quarta Schedulazione - Sera - Stanze Normali
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  QUARTA SCHEDULAZIONE - Sera - Stanze Principali
      default: ""
      
      selector:
        text: {}
    schedule4_evening_fallback_preset:
      name: ğŸ”„ Quarta Schedulazione - Sera - ModalitÃ  Alternativa
      default: "aspira"
      name: ğŸ”„ QUARTA SCHEDULAZIONE - Sera - ModalitÃ  Alternativa
      default: "lava"
      selector:
        select:
          options: ["aspira", "lava", "pulisci", "cleangenius", "cleangenius_deep"]
          
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom
    schedule4_evening_fallback_rooms:
      name: ğŸ”„ Quarta Schedulazione - Sera - Stanze Alternative
      description: |
        **ID numerici (2,3,4) o nomi separati da virgola. Vuoto = tutta casa.**
      name: ğŸ  QUARTA SCHEDULAZIONE - Sera - Stanze Alternative
      default: ""
      selector:
        text: {}

# =========================================
# === TRIGGERS E AZIONI ===
# =========================================
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ› DEBUG
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    debug_mode:
      name: ğŸ› ModalitÃ  Debug
      description: Abilita log dettagliati per troubleshooting
      selector:
        boolean: {}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”¥ TRIGGERS & LOGIC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
trigger:
  # SLOT PRINCIPALE
  # SLOT PRINCIPALE - MATTINA
  - platform: time
    at: !input main_morning_time
    id: main_morning
    enabled: !input main_morning_on
  # SLOT PRINCIPALE - SERA
  - platform: time  
    at: !input main_evening_time
    id: main_evening
  
  # PRIMA SCHEDULAZIONE  
    enabled: !input main_evening_on
  # PRIMA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule1_morning_time
    id: schedule1_morning
    enabled: !input schedule1_morning_on
  # PRIMA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule1_evening_time
    id: schedule1_evening
    
  # SECONDA SCHEDULAZIONE
    enabled: !input schedule1_evening_on
  # SECONDA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule2_morning_time
    id: schedule2_morning
    enabled: !input schedule2_morning_on
  # SECONDA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule2_evening_time
    id: schedule2_evening
    
  # TERZA SCHEDULAZIONE
    enabled: !input schedule2_evening_on
  # TERZA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule3_morning_time
    id: schedule3_morning
    enabled: !input schedule3_morning_on
  # TERZA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule3_evening_time
    id: schedule3_evening
    
  # QUARTA SCHEDULAZIONE
    enabled: !input schedule3_evening_on
  # QUARTA SCHEDULAZIONE - MATTINA
  - platform: time
    at: !input schedule4_morning_time
    id: schedule4_morning
    enabled: !input schedule4_morning_on
  # QUARTA SCHEDULAZIONE - SERA
  - platform: time
    at: !input schedule4_evening_time
    id: schedule4_evening
    
  # Reset flag giornaliero
  - platform: time
    at: "23:59:00"
    id: reset_flag
variables:
  # EntitÃ  principali
  vacuum_ent: !input vacuum_entity
  robot_status: !input robot_status_sensor
  valid_states: !input valid_robot_states
  presence_ent: !input presence_entity
  pres_val: !input presence_value
  flag_cleaned: !input flag_cleaned_today
  notification_targets: !input notification_targets
  debug_enabled: !input debug_mode
    enabled: !input schedule4_evening_on

action:
  # === RESET FLAG GIORNALIERO ===
  - if:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ›¡ï¸ CONDIZIONI GLOBALI
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
condition:
  - condition: and
    conditions:
      # ROBOT IN STATO VALIDO (HARDCODATO)
      - condition: template
        value_template: "{{ trigger.id == 'reset_flag' }}"
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              message: "[DREAME BLUEPRINT] ğŸŒ™ Reset flag pulizia giornaliero"
              level: info
      - service: input_boolean.turn_off
        target:
          entity_id: "{{ flag_cleaned }}"
      - stop: "Reset flag completato"
  # === CONTROLLO COLLISIONI (DEBUG) ===
  - if:
        value_template: >
          {{ states(!input robot_status_sensor) in ['idle', 'sleeping', 'charging', 'docked'] }}
      
      # CONTROLLO PRESENZA
      - condition: template
        value_template: "{{ debug_enabled and trigger.id != 'reset_flag' }}"
    then:
      - service: system_log.write
        data:
          message: |
            [DREAME BLUEPRINT] ğŸ” Trigger attivato: {{ trigger.id }}
            - Robot Status: {{ states(robot_status) if robot_status != '' else 'N/A' }}
            - Presenza: {{ states(presence_ent) if presence_ent != '' else 'N/A' }}
            - Flag Cleaned: {{ states(flag_cleaned) }}
          level: info
  # === LOGICA PRINCIPALE ===
        value_template: >
          {{ states(!input presence_entity) == !input presence_value }}
      
      # CONTROLLO GIORNO SPECIFICO PER TRIGGER
      - condition: template
        value_template: >
          {%- set current_day = now().strftime('%A') | lower -%}
          {%- set day_mapping = {
            'monday': 'lunedÃ¬', 'tuesday': 'martedÃ¬', 'wednesday': 'mercoledÃ¬',
            'thursday': 'giovedÃ¬', 'friday': 'venerdÃ¬', 'saturday': 'sabato', 'sunday': 'domenica'
          } -%}
          {%- set today_ita = day_mapping[current_day] -%}
          
          {%- if trigger.id == 'main_morning' -%}
            {{ today_ita in !input main_morning_weekdays }}
          {%- elif trigger.id == 'main_evening' -%}
            {{ today_ita in !input main_evening_weekdays }}
          {%- elif trigger.id == 'schedule1_morning' -%}
            {{ today_ita in !input schedule1_morning_weekdays }}
          {%- elif trigger.id == 'schedule1_evening' -%}
            {{ today_ita in !input schedule1_evening_weekdays }}
          {%- elif trigger.id == 'schedule2_morning' -%}
            {{ today_ita in !input schedule2_morning_weekdays }}
          {%- elif trigger.id == 'schedule2_evening' -%}
            {{ today_ita in !input schedule2_evening_weekdays }}
          {%- elif trigger.id == 'schedule3_morning' -%}
            {{ today_ita in !input schedule3_morning_weekdays }}
          {%- elif trigger.id == 'schedule3_evening' -%}
            {{ today_ita in !input schedule3_evening_weekdays }}
          {%- elif trigger.id == 'schedule4_morning' -%}
            {{ today_ita in !input schedule4_morning_weekdays }}
          {%- elif trigger.id == 'schedule4_evening' -%}
            {{ today_ita in !input schedule4_evening_weekdays }}
          {%- else -%}
            false
          {%- endif -%}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ AZIONI
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
action:
  - choose:
      # ===== SLOT PRINCIPALE MATTINA =====
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SLOT PRINCIPALE MATTINA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'main_morning' }}"
          - condition: template
            value_template: "{{ main_on and main_morning_on }}"
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {% set day_map = {
                'monday': 'lunedÃ¬', 'tuesday': 'martedÃ¬', 'wednesday': 'mercoledÃ¬',
                'thursday': 'giovedÃ¬', 'friday': 'venerdÃ¬', 'saturday': 'sabato', 'sunday': 'domenica'
              } %}
              {{ day_map[current_weekday] in main_morning_weekdays }}
          - condition: template
            value_template: |
              {% if robot_status != '' %}
                {{ states(robot_status) in valid_states }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if presence_ent != '' %}
                {{ states(presence_ent) == pres_val }}
              {% else %}
                true
              {% endif %}
        sequence:
          - variables:
              slot_name: "SLOT PRINCIPALE MATTINA"
              slot_preset: !input main_morning_preset
              slot_rooms: !input main_morning_rooms
              slot_sequential: !input main_morning_sequential
              slot_step2_preset: !input main_morning_step2_preset
              slot_step2_rooms: !input main_morning_step2_rooms
              slot_step3_preset: !input main_morning_step3_preset
              slot_step3_rooms: !input main_morning_step3_rooms
              slot_max_wait: !input main_morning_max_wait
          - sequence: &execute_cleaning_sequence
              # === LOG DEBUG ===
              - if:
                  - condition: template
                    value_template: "{{ debug_enabled }}"
                then:
                  - service: system_log.write
                    data:
                      message: >
                        [DREAME BLUEPRINT] ğŸš€ Avvio pulizia {{ slot_name }}
                        - Preset: {{ slot_preset }}
                        - Stanze: {{ slot_rooms }}
                        - Sequenziale: {{ slot_sequential }}
                      level: info
              
              # === NOTIFICA INIZIO ===
              - if:
                  - condition: template
                    value_template: "{{ notification_targets != '' }}"
                then:
                  - repeat:
                      count: >
                        {{ notification_targets.split(',') | length }}
                      sequence:
                        - service: tts.speak
                          target:
                            entity_id: >
                              {{ notification_targets.split(',')[repeat.index - 1].strip() }}
                          data:
                            message: >
                              Avvio pulizia {{ slot_name.lower().replace('slot principale ', '') }}
                              {% if slot_rooms != '' %}
                              stanze: {{ slot_rooms }}
                              {% endif %}
              
              # === PULIZIA STEP 1 ===
              - variables:
                  preset_now: "{{ slot_preset }}"
                  rooms_now: "{{ slot_rooms }}"
              - sequence: &run_cleaning_step
                  - variables:
                      rooms_list: >
                        {% if rooms_now == '' %}
                          []
                        {% else %}
                          {% set room_ids = [] %}
                          {% for room in rooms_now.split(',') %}
                            {% set room = room.strip() %}
                            {% if room.isdigit() %}
                              {% set room_ids = room_ids + [room|int] %}
                            {% else %}
                              {% for entity in states.sensor %}
                                {% if entity.entity_id.startswith(vacuum_ent ~ '_room_') and entity.attributes.get('friendly_name', '').lower() == room.lower() %}
                                  {% set room_ids = room_ids + [entity.state|int] %}
                                {% endif %}
                              {% endfor %}
                            {% endif %}
                          {% endfor %}
                          {{ room_ids }}
                        {% endif %}
                        
                  - choose:
                      # CleanGenius modalitÃ 
                      - conditions: 
                          - condition: template
                            value_template: "{{ preset_now in ['cleangenius', 'cleangenius_deep'] }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ vacuum_ent }}_cleangenius"  
                            data:
                              option: >
                                {% if preset_now == 'cleangenius_deep' %}
                                  cleaning_route
                                {% else %}
                                  standard_cleaning
                                {% endif %}
                          - if:
                              - condition: template
                                value_template: "{{ rooms_list | length > 0 }}"
                            then:
                              - service: vacuum.send_command
                                target:
                                  entity_id: "{{ vacuum_ent }}"
                                data:
                                  command: app_segment_clean
                                  params: "{{ rooms_list }}"
                            else:
                              - service: vacuum.start
                                target:
                                  entity_id: "{{ vacuum_ent }}"
                                  
                      # ModalitÃ  standard
                      - conditions: 
                          - condition: template
                            value_template: "{{ preset_now in ['aspira', 'lava', 'pulisci'] }}"
                        sequence:
                          - service: select.select_option
                            target:
                              entity_id: "{{ vacuum_ent }}_cleaning_mode"
                            data:
                              option: >
                                {% if preset_now == 'aspira' %}
                                  vacuuming
                                {% elif preset_now == 'lava' %}
                                  mopping
                                {% else %}
                                  vacuuming_and_mopping  
                                {% endif %}
                          - if:
                              - condition: template
                                value_template: "{{ rooms_list | length > 0 }}"
                            then:
                              - service: vacuum.send_command
                                target:
                                  entity_id: "{{ vacuum_ent }}"
                                data:
                                  command: app_segment_clean
                                  params: "{{ rooms_list }}"
                            else:
                              - service: vacuum.start
                                target:
                                  entity_id: "{{ vacuum_ent }}"
              
              # === ATTESA COMPLETAMENTO PER STEP SUCCESSIVI ===
              - if:
                  - condition: template
                    value_template: "{{ slot_sequential and (slot_step2_preset != '' or slot_step3_preset != '') }}"
                then:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: system_log.write
                        data:
                          message: "[DREAME BLUEPRINT] â³ Attesa completamento Step 1..."
                          level: info
                  
                  - wait_template: >
                      {{ states(vacuum_ent) in ['idle', 'sleeping', 'charging', 'docked'] }}
                    timeout: "{{ (slot_max_wait * 60) | int }}"
                        
                  - if:
                      - condition: template
                        value_template: "{{ wait.completed }}"
                      - condition: template
                        value_template: "{{ slot_step2_preset != '' }}"
                    then:
                      # === PULIZIA STEP 2 ===
                      - if:
                          - condition: template
                            value_template: "{{ debug_enabled }}"
                        then:
                          - service: system_log.write
                            data:
                              message: "[DREAME BLUEPRINT] ğŸš€ Avvio Step 2"
                              level: info
                      
                      - variables:
                          preset_now: "{{ slot_step2_preset }}"
                          rooms_now: "{{ slot_step2_rooms }}"
                      - sequence: *run_cleaning_step
                      
                      # === ATTESA PER STEP 3 ===
                      - if:
                          - condition: template
                            value_template: "{{ slot_step3_preset != '' }}"
                        then:
                          - wait_template: >
                              {{ states(vacuum_ent) in ['idle', 'sleeping', 'charging', 'docked'] }}
                                entity_id: "{{ vacuum_ent }}"
                            timeout: "{{ (slot_max_wait * 60) | int }}"
                                
                          - if:
                              - condition: template
                                value_template: "{{ wait.completed }}"
                            then:
                              # === PULIZIA STEP 3 ===
                              - if:
                                  - condition: template
                                    value_template: "{{ debug_enabled }}"
                                then:
                                  - service: system_log.write
                                    data:
                                      message: "[DREAME BLUEPRINT] ğŸš€ Avvio Step 3"
                                      level: info
                              
                              - variables:
                                  preset_now: "{{ slot_step3_preset }}"
                                  rooms_now: "{{ slot_step3_rooms }}"
                              - sequence: *run_cleaning_step
              
              # === IMPOSTA FLAG PULIZIA ===
              - service: input_boolean.turn_on
                target:
                  entity_id: "{{ flag_cleaned }}"
                  
              # === NOTIFICA COMPLETAMENTO ===
              - if:
                  - condition: template
                    value_template: "{{ notification_targets != '' }}"
                then:
                  - repeat:
                      count: >
                        {{ notification_targets.split(',') | length }}
                      sequence:
                        - service: tts.speak
                          target:
                            entity_id: >
                              {{ notification_targets.split(',')[repeat.index - 1].strip() }}
                          data:
                            message: "Pulizia {{ slot_name.lower().replace('slot principale ', '') }} avviata con successo"
      # ===== SLOT PRINCIPALE SERA (CON LOGICA ADATTIVA) =====
          - if:
              - condition: template
                value_template: "{{ !input debug_mode }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "ğŸŒ… Dreame - Slot Principale Mattina"
                  message: >
                    Avvio pulizia mattutina:
                    - ModalitÃ : {{ !input main_morning_preset }}
                    - Stanze: {{ !input main_morning_rooms if !input main_morning_rooms else 'Tutta casa' }}
                    - Orario: {{ !input main_morning_time }}
          
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: !input vacuum_entity
            data:
              segments: >
                {% if !input main_morning_rooms %}
                  {{ !input main_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: !input main_morning_preset
          - service: input_boolean.turn_on
            target:
              entity_id: !input flag_cleaned_today
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SLOT PRINCIPALE SERA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'main_evening' }}"
          - condition: template
            value_template: "{{ main_on and main_evening_on }}"
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {% set day_map = {
                'monday': 'lunedÃ¬', 'tuesday': 'martedÃ¬', 'wednesday': 'mercoledÃ¬',
                'thursday': 'giovedÃ¬', 'friday': 'venerdÃ¬', 'saturday': 'sabato', 'sunday': 'domenica'
              } %}
              {{ day_map[current_weekday] in main_evening_weekdays }}
          - condition: template
            value_template: |
              {% if robot_status != '' %}
                {{ states(robot_status) in valid_states }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if presence_ent != '' %}
                {{ states(presence_ent) == pres_val }}
              {% else %}
                true
              {% endif %}
        sequence:
          # === LOGICA ADATTIVA ===
          - variables:
              already_cleaned: "{{ states(!input flag_cleaned_today) == 'on' }}"
              conditional_mode: "{{ !input main_evening_conditional }}"
              
          - if:
              - condition: template
                value_template: "{{ !input debug_mode }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "ğŸŒ™ Dreame - Slot Principale Sera"
                  message: >
                    Controllo pulizia serale:
                    - GiÃ  pulito oggi: {{ already_cleaned }}
                    - Logica: {{ conditional_mode }}
                    - ModalitÃ  primaria: {{ !input main_evening_preset }}
                    {% if conditional_mode == 'adapt_if_cleaned' %}
                    - ModalitÃ  alternativa: {{ !input main_evening_fallback_preset }}
                    {% endif %}
          - choose:
              # Skip se giÃ  pulito
              # SALTA SE GIÃ€ PULITO
              - conditions:
                  - condition: template
                    value_template: "{{ main_evening_conditional == 'skip_if_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                        value_template: "{{ !input debug_mode }}"
                    then:
                      - service: system_log.write
                      - service: persistent_notification.create
                        data:
                          message: "[DREAME BLUEPRINT] â­ï¸ Slot Principale SERA saltato - giÃ  pulito oggi"
                          level: info
                  - stop: "Pulizia giÃ  effettuata oggi"
              
              # Esegui solo se non pulito
              - conditions:
                  - condition: template
                    value_template: "{{ main_evening_conditional == 'fallback_if_not_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'off') }}"
                sequence:
                  - variables:
                      slot_name: "SLOT PRINCIPALE SERA (Recupero)"
                      slot_preset: !input main_evening_preset
                      slot_rooms: !input main_evening_rooms
                      slot_sequential: !input main_evening_sequential
                      slot_step2_preset: !input main_evening_step2_preset
                      slot_step2_rooms: !input main_evening_step2_rooms
                      slot_step3_preset: !input main_evening_step3_preset
                      slot_step3_rooms: !input main_evening_step3_rooms
                      slot_max_wait: !input main_evening_max_wait
                  - sequence: *execute_cleaning_sequence
              
              # Adatta modalitÃ  se giÃ  pulito
                          title: "â­ï¸ Dreame - Pulizia Saltata"
                          message: "Pulizia serale saltata: giÃ  pulito oggi"
              # MODALITÃ€ ADATTIVA
              - conditions:
                  - condition: template
                    value_template: "{{ main_evening_conditional == 'adapt_if_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - variables:
                      slot_name: "SLOT PRINCIPALE SERA (ModalitÃ  Leggera)"
                      slot_preset: !input main_evening_fallback_preset
                      slot_rooms: !input main_evening_fallback_rooms
                      slot_sequential: !input main_evening_sequential
                      slot_step2_preset: !input main_evening_step2_preset
                      slot_step2_rooms: !input main_evening_step2_rooms
                      slot_step3_preset: !input main_evening_step3_preset
                      slot_step3_rooms: !input main_evening_step3_rooms
                      slot_max_wait: !input main_evening_max_wait
                  - sequence: *execute_cleaning_sequence
              
              # Esegui sempre (modalitÃ  normale)
              - conditions: []
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - variables:
                      slot_name: "SLOT PRINCIPALE SERA"
                      slot_preset: !input main_evening_preset
                      slot_rooms: !input main_evening_rooms
                      slot_sequential: !input main_evening_sequential
                      slot_step2_preset: !input main_evening_step2_preset
                      slot_step2_rooms: !input main_evening_step2_rooms
                      slot_step3_preset: !input main_evening_step3_preset
                      slot_step3_rooms: !input main_evening_step3_rooms
                      slot_max_wait: !input main_evening_max_wait
                  - sequence: *execute_cleaning_sequence
      # ===== PRIMA SCHEDULAZIONE MATTINA =====
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: !input vacuum_entity
                    data:
                      segments: >
                        {% if !input main_evening_fallback_rooms %}
                          {{ !input main_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: !input main_evening_fallback_preset
            # DEFAULT: PULIZIA NORMALE
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: !input vacuum_entity
                data:
                  segments: >
                    {% if !input main_evening_rooms %}
                      {{ !input main_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: !input main_evening_preset
              - service: input_boolean.turn_on
                target:
                  entity_id: !input flag_cleaned_today
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PRIMA SCHEDULAZIONE MATTINA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule1_morning' }}"
          - condition: template
            value_template: "{{ schedule1_on and schedule1_morning_on }}"
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {% set day_map = {
                'monday': 'lunedÃ¬', 'tuesday': 'martedÃ¬', 'wednesday': 'mercoledÃ¬',
                'thursday': 'giovedÃ¬', 'friday': 'venerdÃ¬', 'saturday': 'sabato', 'sunday': 'domenica'
              } %}
              {{ day_map[current_weekday] in schedule1_morning_weekdays }}
          - condition: template
            value_template: |
              {% if robot_status != '' %}
                {{ states(robot_status) in valid_states }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if presence_ent != '' %}
                {{ states(presence_ent) == pres_val }}
              {% else %}
                true
              {% endif %}
        sequence:
          - variables:
              slot_name: "PRIMA SCHEDULAZIONE MATTINA"
              slot_preset: !input schedule1_morning_preset
              slot_rooms: !input schedule1_morning_rooms
              slot_sequential: false
              slot_step2_preset: ""
              slot_step2_rooms: ""
              slot_step3_preset: ""
              slot_step3_rooms: ""
              slot_max_wait: 60
          - sequence: *execute_cleaning_sequence
      # ===== PRIMA SCHEDULAZIONE SERA (CON LOGICA ADATTIVA) =====
          - if:
              - condition: template
                value_template: "{{ !input debug_mode }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "ğŸŒ… Dreame - Prima Schedulazione Mattina"
                  message: >
                    Avvio prima schedulazione mattutina:
                    - ModalitÃ : {{ !input schedule1_morning_preset }}
                    - Stanze: {{ !input schedule1_morning_rooms if !input schedule1_morning_rooms else 'Tutta casa' }}
          
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: !input vacuum_entity
            data:
              segments: >
                {% if !input schedule1_morning_rooms %}
                  {{ !input schedule1_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: !input schedule1_morning_preset
          - service: input_boolean.turn_on
            target:
              entity_id: !input flag_cleaned_today
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PRIMA SCHEDULAZIONE SERA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule1_evening' }}"
          - condition: template
            value_template: "{{ schedule1_on and schedule1_evening_on }}"
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {% set day_map = {
                'monday': 'lunedÃ¬', 'tuesday': 'martedÃ¬', 'wednesday': 'mercoledÃ¬',
                'thursday': 'giovedÃ¬', 'friday': 'venerdÃ¬', 'saturday': 'sabato', 'sunday': 'domenica'
              } %}
              {{ day_map[current_weekday] in schedule1_evening_weekdays }}
          - condition: template
            value_template: |
              {% if robot_status != '' %}
                {{ states(robot_status) in valid_states }}
              {% else %}
                true
              {% endif %}
          - condition: template
            value_template: |
              {% if presence_ent != '' %}
                {{ states(presence_ent) == pres_val }}
              {% else %}
                true
              {% endif %}
        sequence:
          # === LOGICA ADATTIVA PRIMA SCHEDULAZIONE ===
          - variables:
              already_cleaned: "{{ states(!input flag_cleaned_today) == 'on' }}"
              conditional_mode: "{{ !input schedule1_evening_conditional }}"
              
          - choose:
              # Skip se giÃ  pulito
              - conditions:
                  - condition: template
                    value_template: "{{ schedule1_evening_conditional == 'skip_if_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                        value_template: "{{ !input debug_mode }}"
                    then:
                      - service: system_log.write
                      - service: persistent_notification.create
                        data:
                          message: "[DREAME BLUEPRINT] â­ï¸ Prima Schedulazione SERA saltata - giÃ  pulito oggi"
                          level: info
                  - stop: "Pulizia giÃ  effettuata oggi"
              
              # Esegui solo se non pulito
              - conditions:
                  - condition: template
                    value_template: "{{ schedule1_evening_conditional == 'fallback_if_not_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'off') }}"
                sequence:
                  - variables:
                      slot_name: "PRIMA SCHEDULAZIONE SERA (Recupero)"
                      slot_preset: !input schedule1_evening_preset
                      slot_rooms: !input schedule1_evening_rooms
                      slot_sequential: false
                      slot_step2_preset: ""
                      slot_step2_rooms: ""
                      slot_step3_preset: ""
                      slot_step3_rooms: ""
                      slot_max_wait: 60
                  - sequence: *execute_cleaning_sequence
              
              # Adatta modalitÃ  se giÃ  pulito
              - conditions:
                  - condition: template
                    value_template: "{{ schedule1_evening_conditional == 'adapt_if_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - variables:
                      slot_name: "PRIMA SCHEDULAZIONE SERA (ModalitÃ  Leggera)"
                      slot_preset: !input schedule1_evening_fallback_preset
                      slot_rooms: !input schedule1_evening_fallback_rooms
                      slot_sequential: false
                      slot_step2_preset: ""
                      slot_step2_rooms: ""
                      slot_step3_preset: ""
                      slot_step3_rooms: ""
                      slot_max_wait: 60
                  - sequence: *execute_cleaning_sequence
              
              # Esegui sempre
              - conditions: []
                sequence:
                  - variables:
                      slot_name: "PRIMA SCHEDULAZIONE SERA"
                      slot_preset: !input schedule1_evening_preset
                      slot_rooms: !input schedule1_evening_rooms
                      slot_sequential: false
                      slot_step2_preset: ""
                      slot_step2_rooms: ""
                      slot_step3_preset: ""
                      slot_step3_rooms: ""
                      slot_max_wait: 60
                  - sequence: *execute_cleaning_sequence
      # ===== SECONDA SCHEDULAZIONE MATTINA =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule2_morning' }}"
          - condition: template
            value_template: "{{ schedule2_on and schedule2_morning_on }}"
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {% set day_map = {
                'monday': 'lunedÃ¬', 'tuesday': 'martedÃ¬', 'wednesday': 'mercoledÃ¬',
                'thursday': 'giovedÃ¬', 'friday': 'venerdÃ¬', 'saturday': 'sabato', 'sunday': 'domenica'
              } %}
              {{ day_map[current_weekday] in schedule2_morning_weekdays }}
        sequence:
          - variables:
              slot_name: "SECONDA SCHEDULAZIONE MATTINA"
              slot_preset: !input schedule2_morning_preset
              slot_rooms: !input schedule2_morning_rooms
              slot_sequential: false
              slot_step2_preset: ""
              slot_step2_rooms: ""
              slot_step3_preset: ""
              slot_step3_rooms: ""
              slot_max_wait: 60
          - sequence: *execute_cleaning_sequence
      # ===== SECONDA SCHEDULAZIONE SERA =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule2_evening' }}"
          - condition: template
            value_template: "{{ schedule2_on and schedule2_evening_on }}"
          - condition: template
            value_template: |
              {% set current_weekday = now().strftime('%A').lower() %}
              {% set day_map = {
                'monday': 'lunedÃ¬', 'tuesday': 'martedÃ¬', 'wednesday': 'mercoledÃ¬',
                'thursday': 'giovedÃ¬', 'friday': 'venerdÃ¬', 'saturday': 'sabato', 'sunday': 'domenica'
              } %}
              {{ day_map[current_weekday] in schedule2_evening_weekdays }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ schedule2_evening_conditional == 'skip_if_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - stop: "Pulizia giÃ  effettuata oggi"
              
              - conditions:
                  - condition: template
                    value_template: "{{ schedule2_evening_conditional == 'fallback_if_not_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'off') }}"
                sequence:
                  - variables:
                      slot_name: "SECONDA SCHEDULAZIONE SERA (Recupero)"
                      slot_preset: !input schedule2_evening_preset
                      slot_rooms: !input schedule2_evening_rooms
                      slot_sequential: false
                      slot_step2_preset: ""
                      slot_step2_rooms: ""
                      slot_step3_preset: ""
                      slot_step3_rooms: ""
                      slot_max_wait: 60
                  - sequence: *execute_cleaning_sequence
              
              - conditions:
                  - condition: template
                    value_template: "{{ schedule2_evening_conditional == 'adapt_if_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - variables:
                      slot_name: "SECONDA SCHEDULAZIONE SERA (ModalitÃ  Leggera)"
                      slot_preset: !input schedule2_evening_fallback_preset
                      slot_rooms: !input schedule2_evening_fallback_rooms
                      slot_sequential: false
                      slot_step2_preset: ""
                      slot_step2_rooms: ""
                      slot_step3_preset: ""
                      slot_step3_rooms: ""
                      slot_max_wait: 60
                  - sequence: *execute_cleaning_sequence
              
              - conditions: []
                sequence:
                  - variables:
                      slot_name: "SECONDA SCHEDULAZIONE SERA"
                      slot_preset: !input schedule2_evening_preset
                      slot_rooms: !input schedule2_evening_rooms
                      slot_sequential: false
                      slot_step2_preset: ""
                      slot_step2_rooms: ""
                      slot_step3_preset: ""
                      slot_step3_rooms: ""
                      slot_max_wait: 60
                  - sequence: *execute_cleaning_sequence
      # ===== TERZA E QUARTA SCHEDULAZIONE (STESSA LOGICA) =====
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule3_morning' }}"
          - condition: template
            value_template: "{{ schedule3_on and schedule3_morning_on }}"
        sequence:
          - variables:
              slot_name: "TERZA SCHEDULAZIONE MATTINA"
              slot_preset: !input schedule3_morning_preset
              slot_rooms: !input schedule3_morning_rooms
              slot_sequential: false
              slot_step2_preset: ""
              slot_step2_rooms: ""
              slot_step3_preset: ""
              slot_step3_rooms: ""
              slot_max_wait: 60
          - sequence: *execute_cleaning_sequence
                          title: "â­ï¸ Dreame - Prima Schedulazione Saltata"
                          message: "Prima schedulazione serale saltata: giÃ  pulito oggi"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule3_evening' }}"
          - condition: template
            value_template: "{{ schedule3_on and schedule3_evening_on }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ schedule3_evening_conditional == 'skip_if_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - stop: "Pulizia giÃ  effettuata oggi"
              - conditions: []
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - variables:
                      slot_name: "TERZA SCHEDULAZIONE SERA"
                      slot_preset: !input schedule3_evening_preset
                      slot_rooms: !input schedule3_evening_rooms
                      slot_sequential: false
                      slot_step2_preset: ""
                      slot_step2_rooms: ""
                      slot_step3_preset: ""
                      slot_step3_rooms: ""
                      slot_max_wait: 60
                  - sequence: *execute_cleaning_sequence
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: !input vacuum_entity
                    data:
                      segments: >
                        {% if !input schedule1_evening_fallback_rooms %}
                          {{ !input schedule1_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: !input schedule1_evening_fallback_preset

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule4_morning' }}"
          - condition: template
            value_template: "{{ schedule4_on and schedule4_morning_on }}"
        sequence:
          - variables:
              slot_name: "QUARTA SCHEDULAZIONE MATTINA"
              slot_preset: !input schedule4_morning_preset
              slot_rooms: !input schedule4_morning_rooms
              slot_sequential: false
              slot_step2_preset: ""
              slot_step2_rooms: ""
              slot_step3_preset: ""
              slot_step3_rooms: ""
              slot_max_wait: 60
          - sequence: *execute_cleaning_sequence
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: !input vacuum_entity
                data:
                  segments: >
                    {% if !input schedule1_evening_rooms %}
                      {{ !input schedule1_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: !input schedule1_evening_preset

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule4_evening' }}"
              - service: input_boolean.turn_on
                target:
                  entity_id: !input flag_cleaned_today
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALTRE SCHEDULAZIONI (2, 3, 4) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # [Le altre schedulazioni seguono la stessa logica - implementa se necessario]
    # DEFAULT FALLBACK
    default:
      - if:
          - condition: template
            value_template: "{{ schedule4_on and schedule4_evening_on }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ schedule4_evening_conditional == 'skip_if_cleaned' }}"
                  - condition: template
                    value_template: "{{ is_state(flag_cleaned, 'on') }}"
                sequence:
                  - stop: "Pulizia giÃ  effettuata oggi"
              - conditions: []
                sequence:
                  - variables:
                      slot_name: "QUARTA SCHEDULAZIONE SERA"
                      slot_preset: !input schedule4_evening_preset
                      slot_rooms: !input schedule4_evening_rooms
                      slot_sequential: false
                      slot_step2_preset: ""
                      slot_step2_rooms: ""
                      slot_step3_preset: ""
                      slot_step3_rooms: ""
                      slot_max_wait: 60
                  - sequence: *execute_cleaning_sequence
mode: single
max_exceeded: silent
            value_template: "{{ !input debug_mode }}"
        then:
          - service: persistent_notification.create
            data:
              title: "âŒ Dreame - Errore"
              message: >
                Trigger non riconosciuto: {{ trigger.id }}
                Controlla la configurazione del blueprint.
0 commit comments
Comments
0
 (0)
Comment
You're not receiving notifications from this thread.

Update 3_CleaningAutomations.yaml Â· Magnum9O/HA_BluePrints@1736223There are no files selected for viewing
