blueprint:
  name: ü§ñ Dreame Vacuum - Automazione Pulizie Avanzata
  description: |
    üöÄ **SISTEMA INTELLIGENTE DI PULIZIE AUTOMATICHE**
    
    ‚ú® **CARATTERISTICHE:**
    - üéØ **Slot Principale**: Mattina standard + Sera con logica adattiva
    - üìÖ **4 Schedulazioni Aggiuntive**: Tutte con logica adattiva intelligente  
    - üß† **Controlli Automatici**: Verifica stato robot e presenza
    - üîÑ **Logica Adattiva Avanzata**: Evita pulizie ridondanti
    - üè† **Configurazione Flessibile**: Ogni slot indipendente
    
    üìã **COME FUNZIONA:**
    - Ogni slot pu√≤ essere abilitato/disabilitato separatamente (mattina/sera)
    - Le pulizie serali si adattano automaticamente in base alla situazione
    - Sistema ottimizzato per evitare sprechi energetici

  domain: automation
  input:
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # üîß CONFIGURAZIONE BASE - ENTIT√Ä NECESSARIE
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    vacuum_entity:
      name: ü§ñ Robot Aspirapolvere
      description: |
        **Seleziona l'entit√† principale del tuo robot Dreame**
        
        üìç **Dove trovarla:** Impostazioni ‚Üí Dispositivi e servizi ‚Üí Dreame ‚Üí Cerca entit√† tipo `vacuum.nome_robot`
        
        ‚úÖ **Esempi comuni:**
        - `vacuum.dreame_l10s_ultra`
        - `vacuum.ambrogio`  
        - `vacuum.dreame_robot_vacuum`
        
        ‚ö†Ô∏è **Importante:** Deve essere l'entit√† principale (domain: vacuum), NON i sensori!
      selector:
        entity:
          domain: vacuum

    robot_status_sensor:
      name: üìä Sensore Stato Robot
      description: |
        **Sensore che riporta lo stato dettagliato del robot (idle, cleaning, returning, etc.)**
        
        üìç **Come trovarlo:** 
        1. Impostazioni ‚Üí Dispositivi e servizi ‚Üí Dreame
        2. Cerca un sensore con nome tipo `sensor.nome_robot_status` o `sensor.nome_robot_state`
        3. Gli stati comuni sono: `idle`, `cleaning`, `returning`, `charging`, `docked`, `paused`
        
        ‚úÖ **Esempi:**
        - `sensor.dreame_l10s_ultra_status`
        - `sensor.ambrogio_status_2` 
        - `sensor.dreame_robot_vacuum_state`
        
        üéØ **A cosa serve:** Il blueprint controlla che il robot sia in uno stato valido (`idle`, `sleeping`, `charging`, `docked`) prima di avviare una pulizia
      selector:
        entity:
          domain: sensor

    presence_entity:
      name: üë• Sensore di Presenza
      description: |
        **Entit√† che indica se qualcuno √® presente in casa**
        
        üéØ **A COSA SERVE:** Il robot pulisce SOLO quando la casa √® vuota (per sicurezza e comodit√†)
        
        üìç **Opzioni comuni:**
        
        **üè† COUNTER (pi√π semplice):**
        - `counter.away_home` (0 = casa vuota, 1+ = qualcuno presente)
        
        **üë§ PERSON TRACKER:**
        - `person.nome_persona` (away = fuori, home = presente)
        
        **üè¢ ZONE BASED:**
        - `input_select.house_mode` (away/home/night)
        - `binary_sensor.house_occupied`
        
        **üì± DEVICE TRACKER:**
        - `device_tracker.telefono` (away/home)
        
        ‚ö†Ô∏è **Nota:** Configura il "Valore Casa Vuota" nel campo successivo!
      selector:
        entity: {}

    presence_value:
      name: üè† Valore "Casa Vuota"  
      description: |
        **Il valore che indica che la casa √® vuota**
        
        üìç **Esempi in base al sensore scelto:**
        
        **Se hai scelto un COUNTER:** `0`
        **Se hai scelto una PERSON:** `away` 
        **Se hai scelto un INPUT_SELECT:** `away`
        **Se hai scelto un BINARY_SENSOR:** `off`
        **Se hai scelto un DEVICE_TRACKER:** `not_home`
        
        üí° **Consiglio:** Guarda negli "Stati sviluppatori" il valore effettivo del tuo sensore quando sei fuori casa
      default: "0"
      selector:
        text: {}

    flag_cleaned_today:
      name: üèÅ Flag Pulizia Completata
      description: |
        **Input boolean che traccia se √® gi√† stato pulito oggi (necessario per logica adattiva)**
        
        üéØ **A COSA SERVE:**
        - Evita pulizie ridondanti nella stessa giornata
        - Permette alla logica adattiva di funzionare (salta/adatta le pulizie serali)
        - Si resetta automaticamente ogni giorno a mezzanotte
        
        üìç **COME CREARLO:**
        1. Impostazioni ‚Üí Dispositivi e servizi ‚Üí Helper
        2. Crea Helper ‚Üí Toggle (Boolean)
        3. Nome: "Cleaned Today" o "Pulito Oggi"
        4. ID entit√†: `cleaned_today`
        
        ‚úÖ **Risultato finale:** `input_boolean.cleaned_today`
        
        üîÑ **AUTOMAZIONE RESET (OPZIONALE):**
        ```
        - id: reset_cleaned_today
          alias: Reset Flag Pulizia
          trigger:
            platform: time
            at: "00:00:00"
          action:
            service: input_boolean.turn_off
            target:
              entity_id: input_boolean.cleaned_today
        ```
      selector:
        entity:
          domain: input_boolean

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # üéØ PULIZIE AUTOMATICHE
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SLOT PRINCIPALE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    main_weekdays:
      name: üìÖ SLOT PRINCIPALE - Giorni Attivi
      description: |
        **Giorni della settimana in cui lo slot principale √® attivo**
        
        üí° **Questo vale per ENTRAMBI mattina e sera dello slot principale**
        üìã **Esempi:**
        - Giorni lavorativi: Luned√¨-Venerd√¨
        - Solo weekend: Sabato, Domenica  
        - Alternato: Luned√¨, Mercoled√¨, Venerd√¨
      selector:
        select:
          multiple: true
          mode: dropdown
          options:
            - luned√¨
            - marted√¨
            - mercoled√¨
            - gioved√¨
            - venerd√¨
            - sabato
            - domenica

    main_morning_on:
      name: üåÖ SLOT PRINCIPALE - Mattina - Abilita
      description: |
        **Attiva la pulizia mattutina del programma principale**
        
        üéØ **COMPORTAMENTO:** Sempre eseguita quando abilitata (senza logica adattiva)
        üí° **Ideale per:** Pulizia quotidiana garantita prima che tutti si sveglino
      selector:
        boolean: {}

    main_morning_time:
      name: ‚è∞ SLOT PRINCIPALE - Mattina - Orario
      description: Orario per la pulizia mattutina del programma principale
      default: "05:00:00"
      selector:
        time: {}

    main_morning_preset:
      name: üéØ SLOT PRINCIPALE - Mattina - Modalit√†
      description: |
        **Modalit√† di pulizia per il programma mattutino**
        
        üéØ **MODALIT√Ä DISPONIBILI:**
        - **aspira**: Solo aspirazione (veloce)
        - **lava**: Solo lavaggio (con panno)  
        - **aspira_lava**: Aspira + lava (completo)
        - **cleangenius_deep**: AI cleaning profondo
        - **spot_cleaning**: Pulizia mirata
        - **custom**: Modalit√† personalizzata
        
        üí° **Suggerimento mattina:** `aspira` (veloce per non disturbare)
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_morning_rooms:
      name: üè† SLOT PRINCIPALE - Mattina - Stanze
      description: "ID delle stanze da pulire separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    main_evening_on:
      name: üåô SLOT PRINCIPALE - Sera - Abilita
      description: Attiva la pulizia serale del programma principale (con logica adattiva configurabile)
      selector:
        boolean: {}

    main_evening_time:
      name: ‚è∞ SLOT PRINCIPALE - Sera - Orario
      description: Orario per la pulizia serale del programma principale
      default: "23:00:00"
      selector:
        time: {}

    main_evening_conditional:
      name: üß† SLOT PRINCIPALE - Sera - Logica Adattiva
      description: |
        **Come comportarsi in base allo stato del flag pulizia:**
        
        - **üîÑ Esegui sempre:** Ignora lo stato del flag e pulisce sempre con modalit√† principale
        - **‚è≠Ô∏è Salta se gi√† pulito:** Non fa nulla se il flag indica che √® gi√† stato pulito oggi  
        - **üß† Adatta modalit√†:** Se gi√† pulito oggi, usa modalit√† e stanze alternative invece di quelle principali
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "üîÑ Esegui Sempre"
            - value: "skip_if_cleaned"  
              label: "‚è≠Ô∏è Salta se gi√† pulito"
            - value: "adapt_if_cleaned"
              label: "üß† Adatta modalit√†"

    main_evening_preset:
      name: üéØ SLOT PRINCIPALE - Sera - Modalit√† Principale
      description: Modalit√† di pulizia principale da utilizzare per il programma serale (usata sempre, tranne se logica adattiva sceglie modalit√† alternativa)
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_evening_rooms:
      name: üè† SLOT PRINCIPALE - Sera - Stanze Principali
      description: "ID delle stanze da pulire con modalit√† principale, separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    main_evening_fallback_preset:
      name: üîÑ SLOT PRINCIPALE - Sera - Modalit√† Alternativa
      description: Modalit√† di pulizia alternativa da usare quando la logica adattiva √® impostata su "Adatta modalit√†" e il robot √® gi√† stato utilizzato oggi
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    main_evening_fallback_rooms:
      name: üè† SLOT PRINCIPALE - Sera - Stanze Alternative
      description: "ID delle stanze da pulire con modalit√† alternativa (esempio: solo bagno = 3). Se vuoto, usa le stesse stanze principali"
      default: ""
      selector:
        text: {}

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PRIMA SCHEDULAZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    schedule1_weekdays:
      name: üìÖ PRIMA SCHEDULAZIONE - Giorni Attivi
      description: Giorni della settimana in cui la prima schedulazione √® attiva (vale per mattina e sera)
      selector:
        select:
          multiple: true
          mode: dropdown
          options:
            - luned√¨
            - marted√¨
            - mercoled√¨
            - gioved√¨
            - venerd√¨
            - sabato
            - domenica

    schedule1_morning_on:
      name: üåÖ PRIMA SCHEDULAZIONE - Mattina - Abilita
      description: Attiva la pulizia mattutina della prima schedulazione aggiuntiva
      selector:
        boolean: {}

    schedule1_morning_time:
      name: ‚è∞ PRIMA SCHEDULAZIONE - Mattina - Orario
      description: Orario per la pulizia mattutina della prima schedulazione aggiuntiva
      default: "05:00:00"
      selector:
        time: {}

    schedule1_morning_preset:
      name: üéØ PRIMA SCHEDULAZIONE - Mattina - Modalit√†
      description: Modalit√† di pulizia per il programma mattutino della prima schedulazione aggiuntiva
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_morning_rooms:
      name: üè† PRIMA SCHEDULAZIONE - Mattina - Stanze
      description: "ID delle stanze da pulire separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    schedule1_evening_on:
      name: üåô PRIMA SCHEDULAZIONE - Sera - Abilita
      description: Attiva la pulizia serale della prima schedulazione aggiuntiva (con logica adattiva)
      selector:
        boolean: {}

    schedule1_evening_time:
      name: ‚è∞ PRIMA SCHEDULAZIONE - Sera - Orario
      description: Orario per la pulizia serale della prima schedulazione aggiuntiva
      default: "23:00:00"
      selector:
        time: {}

    schedule1_evening_conditional:
      name: üß† PRIMA SCHEDULAZIONE - Sera - Logica Adattiva
      description: |
        **Come comportarsi in base allo stato del flag pulizia:**
        
        - **üîÑ Esegui sempre:** Ignora lo stato del flag e pulisce sempre con modalit√† principale
        - **‚è≠Ô∏è Salta se gi√† pulito:** Non fa nulla se il flag indica che √® gi√† stato pulito oggi  
        - **üß† Adatta modalit√†:** Se gi√† pulito oggi, usa modalit√† e stanze alternative invece di quelle principali
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "üîÑ Esegui Sempre"
            - value: "skip_if_cleaned"
              label: "‚è≠Ô∏è Salta se gi√† pulito"
            - value: "adapt_if_cleaned"
              label: "üß† Adatta modalit√†"

    schedule1_evening_preset:
      name: üéØ PRIMA SCHEDULAZIONE - Sera - Modalit√† Principale
      description: Modalit√† di pulizia principale per il programma serale della prima schedulazione aggiuntiva
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_evening_rooms:
      name: üè† PRIMA SCHEDULAZIONE - Sera - Stanze Principali
      description: "ID delle stanze da pulire con modalit√† principale, separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    schedule1_evening_fallback_preset:
      name: üîÑ PRIMA SCHEDULAZIONE - Sera - Modalit√† Alternativa
      description: Modalit√† di pulizia alternativa da usare quando la logica adattiva sceglie di adattare la modalit√†
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule1_evening_fallback_rooms:
      name: üè† PRIMA SCHEDULAZIONE - Sera - Stanze Alternative
      description: "ID delle stanze da pulire con modalit√† alternativa (esempio: solo bagno = 3). Se vuoto, usa le stesse stanze principali"
      default: ""
      selector:
        text: {}

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SECONDA SCHEDULAZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    schedule2_weekdays:
      name: üìÖ SECONDA SCHEDULAZIONE - Giorni Attivi
      description: Giorni della settimana in cui la seconda schedulazione √® attiva (vale per mattina e sera)
      default: ["domenica"]
      selector:
        select:
          multiple: true
          mode: dropdown
          options:
            - luned√¨
            - marted√¨
            - mercoled√¨
            - gioved√¨
            - venerd√¨
            - sabato
            - domenica

    schedule2_morning_on:
      name: üåÖ SECONDA SCHEDULAZIONE - Mattina - Abilita
      description: Attiva la pulizia mattutina della seconda schedulazione aggiuntiva
      selector:
        boolean: {}

    schedule2_morning_time:
      name: ‚è∞ SECONDA SCHEDULAZIONE - Mattina - Orario
      description: Orario per la pulizia mattutina della seconda schedulazione aggiuntiva
      default: "05:00:00"
      selector:
        time: {}

    schedule2_morning_preset:
      name: üéØ SECONDA SCHEDULAZIONE - Mattina - Modalit√†
      description: Modalit√† di pulizia per il programma mattutino della seconda schedulazione aggiuntiva
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_morning_rooms:
      name: üè† SECONDA SCHEDULAZIONE - Mattina - Stanze
      description: "ID delle stanze da pulire separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    schedule2_evening_on:
      name: üåô SECONDA SCHEDULAZIONE - Sera - Abilita
      description: Attiva la pulizia serale della seconda schedulazione aggiuntiva (con logica adattiva)
      selector:
        boolean: {}

    schedule2_evening_time:
      name: ‚è∞ SECONDA SCHEDULAZIONE - Sera - Orario
      description: Orario per la pulizia serale della seconda schedulazione aggiuntiva
      default: "23:00:00"
      selector:
        time: {}

    schedule2_evening_conditional:
      name: üß† SECONDA SCHEDULAZIONE - Sera - Logica Adattiva
      description: |
        **Come comportarsi in base allo stato del flag pulizia:**
        
        - **üîÑ Esegui sempre:** Ignora lo stato del flag e pulisce sempre con modalit√† principale
        - **‚è≠Ô∏è Salta se gi√† pulito:** Non fa nulla se il flag indica che √® gi√† stato pulito oggi  
        - **üß† Adatta modalit√†:** Se gi√† pulito oggi, usa modalit√† e stanze alternative invece di quelle principali
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "üîÑ Esegui Sempre"
            - value: "skip_if_cleaned"
              label: "‚è≠Ô∏è Salta se gi√† pulito"
            - value: "adapt_if_cleaned"
              label: "üß† Adatta modalit√†"

    schedule2_evening_preset:
      name: üéØ SECONDA SCHEDULAZIONE - Sera - Modalit√† Principale
      description: Modalit√† di pulizia principale per il programma serale della seconda schedulazione aggiuntiva
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_evening_rooms:
      name: üè† SECONDA SCHEDULAZIONE - Sera - Stanze Principali
      description: "ID delle stanze da pulire con modalit√† principale, separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    schedule2_evening_fallback_preset:
      name: üîÑ SECONDA SCHEDULAZIONE - Sera - Modalit√† Alternativa
      description: Modalit√† di pulizia alternativa da usare quando la logica adattiva sceglie di adattare la modalit√†
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule2_evening_fallback_rooms:
      name: üè† SECONDA SCHEDULAZIONE - Sera - Stanze Alternative
      description: "ID delle stanze da pulire con modalit√† alternativa (esempio: solo bagno = 3). Se vuoto, usa le stesse stanze principali"
      default: ""
      selector:
        text: {}

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TERZA SCHEDULAZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    schedule3_weekdays:
      name: üìÖ TERZA SCHEDULAZIONE - Giorni Attivi
      description: Giorni della settimana in cui la terza schedulazione √® attiva (vale per mattina e sera)
      default: ["sabato"]
      selector:
        select:
          multiple: true
          mode: dropdown
          options:
            - luned√¨
            - marted√¨
            - mercoled√¨
            - gioved√¨
            - venerd√¨
            - sabato
            - domenica

    schedule3_morning_on:
      name: üåÖ TERZA SCHEDULAZIONE - Mattina - Abilita
      description: Attiva la pulizia mattutina della terza schedulazione aggiuntiva
      selector:
        boolean: {}

    schedule3_morning_time:
      name: ‚è∞ TERZA SCHEDULAZIONE - Mattina - Orario
      description: Orario per la pulizia mattutina della terza schedulazione aggiuntiva
      default: "05:00:00"
      selector:
        time: {}

    schedule3_morning_preset:
      name: üéØ TERZA SCHEDULAZIONE - Mattina - Modalit√†
      description: Modalit√† di pulizia per il programma mattutino della terza schedulazione aggiuntiva
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_morning_rooms:
      name: üè† TERZA SCHEDULAZIONE - Mattina - Stanze
      description: "ID delle stanze da pulire separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    schedule3_evening_on:
      name: üåô TERZA SCHEDULAZIONE - Sera - Abilita
      description: Attiva la pulizia serale della terza schedulazione aggiuntiva (con logica adattiva)
      selector:
        boolean: {}

    schedule3_evening_time:
      name: ‚è∞ TERZA SCHEDULAZIONE - Sera - Orario
      description: Orario per la pulizia serale della terza schedulazione aggiuntiva
      default: "23:00:00"
      selector:
        time: {}

    schedule3_evening_conditional:
      name: üß† TERZA SCHEDULAZIONE - Sera - Logica Adattiva
      description: |
        **Come comportarsi in base allo stato del flag pulizia:**
        
        - **üîÑ Esegui sempre:** Ignora lo stato del flag e pulisce sempre con modalit√† principale
        - **‚è≠Ô∏è Salta se gi√† pulito:** Non fa nulla se il flag indica che √® gi√† stato pulito oggi  
        - **üß† Adatta modalit√†:** Se gi√† pulito oggi, usa modalit√† e stanze alternative invece di quelle principali
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "üîÑ Esegui Sempre"
            - value: "skip_if_cleaned"
              label: "‚è≠Ô∏è Salta se gi√† pulito"
            - value: "adapt_if_cleaned"
              label: "üß† Adatta modalit√†"

    schedule3_evening_preset:
      name: üéØ TERZA SCHEDULAZIONE - Sera - Modalit√† Principale
      description: Modalit√† di pulizia principale per il programma serale della terza schedulazione aggiuntiva
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_evening_rooms:
      name: üè† TERZA SCHEDULAZIONE - Sera - Stanze Principali
      description: "ID delle stanze da pulire con modalit√† principale, separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    schedule3_evening_fallback_preset:
      name: üîÑ TERZA SCHEDULAZIONE - Sera - Modalit√† Alternativa
      description: Modalit√† di pulizia alternativa da usare quando la logica adattiva sceglie di adattare la modalit√†
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule3_evening_fallback_rooms:
      name: üè† TERZA SCHEDULAZIONE - Sera - Stanze Alternative
      description: "ID delle stanze da pulire con modalit√† alternativa (esempio: solo bagno = 3). Se vuoto, usa le stanze principali"
      default: ""
      selector:
        text: {}

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ QUARTA SCHEDULAZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    schedule4_weekdays:
      name: üìÖ QUARTA SCHEDULAZIONE - Giorni Attivi
      description: Giorni della settimana in cui la quarta schedulazione √® attiva (vale per mattina e sera)
      default: ["domenica"]
      selector:
        select:
          multiple: true
          mode: dropdown
          options:
            - luned√¨
            - marted√¨
            - mercoled√¨
            - gioved√¨
            - venerd√¨
            - sabato
            - domenica

    schedule4_morning_on:
      name: üåÖ QUARTA SCHEDULAZIONE - Mattina - Abilita
      description: Attiva la pulizia mattutina della quarta schedulazione aggiuntiva
      selector:
        boolean: {}

    schedule4_morning_time:
      name: ‚è∞ QUARTA SCHEDULAZIONE - Mattina - Orario
      description: Orario per la pulizia mattutina della quarta schedulazione aggiuntiva
      default: "05:00:00"
      selector:
        time: {}

    schedule4_morning_preset:
      name: üéØ QUARTA SCHEDULAZIONE - Mattina - Modalit√†
      description: Modalit√† di pulizia per il programma mattutino della quarta schedulazione aggiuntiva
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_morning_rooms:
      name: üè† QUARTA SCHEDULAZIONE - Mattina - Stanze
      description: "ID delle stanze da pulire separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    schedule4_evening_on:
      name: üåô QUARTA SCHEDULAZIONE - Sera - Abilita
      description: Attiva la pulizia serale della quarta schedulazione aggiuntiva (con logica adattiva)
      selector:
        boolean: {}

    schedule4_evening_time:
      name: ‚è∞ QUARTA SCHEDULAZIONE - Sera - Orario
      description: Orario per la pulizia serale della quarta schedulazione aggiuntiva
      default: "23:00:00"
      selector:
        time: {}

    schedule4_evening_conditional:
      name: üß† QUARTA SCHEDULAZIONE - Sera - Logica Adattiva
      description: |
        **Come comportarsi in base allo stato del flag pulizia:**
        
        - **üîÑ Esegui sempre:** Ignora lo stato del flag e pulisce sempre con modalit√† principale
        - **‚è≠Ô∏è Salta se gi√† pulito:** Non fa nulla se il flag indica che √® gi√† stato pulito oggi  
        - **üß† Adatta modalit√†:** Se gi√† pulito oggi, usa modalit√† e stanze alternative invece di quelle principali
      default: "always_clean"
      selector:
        select:
          options:
            - value: "always_clean"
              label: "üîÑ Esegui Sempre"
            - value: "skip_if_cleaned"
              label: "‚è≠Ô∏è Salta se gi√† pulito"
            - value: "adapt_if_cleaned"
              label: "üß† Adatta modalit√†"

    schedule4_evening_preset:
      name: üéØ QUARTA SCHEDULAZIONE - Sera - Modalit√† Principale
      description: Modalit√† di pulizia principale per il programma serale della quarta schedulazione aggiuntiva
      default: "aspira"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_evening_rooms:
      name: üè† QUARTA SCHEDULAZIONE - Sera - Stanze Principali
      description: "ID delle stanze da pulire con modalit√† principale, separate da virgole (esempio: 1,2,3) oppure lascia vuoto per pulire tutta la casa"
      default: ""
      selector:
        text: {}

    schedule4_evening_fallback_preset:
      name: üîÑ QUARTA SCHEDULAZIONE - Sera - Modalit√† Alternativa
      description: Modalit√† di pulizia alternativa da usare quando la logica adattiva sceglie di adattare la modalit√†
      default: "lava"
      selector:
        select:
          options:
            - aspira
            - lava
            - aspira_lava
            - cleangenius_deep
            - spot_cleaning
            - custom

    schedule4_evening_fallback_rooms:
      name: üè† QUARTA SCHEDULAZIONE - Sera - Stanze Alternative
      description: "ID delle stanze da pulire con modalit√† alternativa (esempio: solo bagno = 3). Se vuoto, usa le stanze principali"
      default: ""
      selector:
        text: {}

    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # üêõ DEBUG
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    debug_mode:
      name: üêõ Modalit√† Debug
      description: Abilita notifiche dettagliate per troubleshooting e monitoraggio delle operazioni
      selector:
        boolean: {}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# üî• VARIABILI GLOBALI
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
variables:
  robot_status: !input robot_status_sensor
  vacuum_ent: !input vacuum_entity
  presence_ent: !input presence_entity
  pres_val: !input presence_value
  flag_ent: !input flag_cleaned_today
  debug_enabled: !input debug_mode

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ‚ö° TRIGGER SYSTEM
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
trigger:
  - platform: time
    at: !input main_morning_time
    id: main_morning
  - platform: time
    at: !input main_evening_time
    id: main_evening
  - platform: time
    at: !input schedule1_morning_time
    id: schedule1_morning
  - platform: time
    at: !input schedule1_evening_time
    id: schedule1_evening
  - platform: time
    at: !input schedule2_morning_time
    id: schedule2_morning
  - platform: time
    at: !input schedule2_evening_time
    id: schedule2_evening
  - platform: time
    at: !input schedule3_morning_time
    id: schedule3_morning
  - platform: time
    at: !input schedule3_evening_time
    id: schedule3_evening
  - platform: time
    at: !input schedule4_morning_time
    id: schedule4_morning
  - platform: time
    at: !input schedule4_evening_time
    id: schedule4_evening

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# üõ°Ô∏è CONDIZIONI GLOBALI
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
condition:
  - condition: and
    conditions:
      - condition: template
        value_template: >
          {{ states(robot_status) in ['idle', 'sleeping', 'charging', 'docked'] }}
      - condition: template
        value_template: >
          {{ states(presence_ent) == pres_val }}
      - condition: template
        value_template: >
          {%- set current_day = now().strftime('%A') | lower -%}
          {%- set day_mapping = {
            'monday': 'luned√¨', 'tuesday': 'marted√¨', 'wednesday': 'mercoled√¨',
            'thursday': 'gioved√¨', 'friday': 'venerd√¨', 'saturday': 'sabato', 'sunday': 'domenica'
          } -%}
          {%- set today_ita = day_mapping[current_day] -%}
          
          {%- if trigger.id == 'main_morning' -%}
            {{ main_morning_on and today_ita in main_weekdays }}
          {%- elif trigger.id == 'main_evening' -%}
            {{ main_evening_on and today_ita in main_weekdays }}
          {%- elif trigger.id == 'schedule1_morning' -%}
            {{ schedule1_morning_on and today_ita in schedule1_weekdays }}
          {%- elif trigger.id == 'schedule1_evening' -%}
            {{ schedule1_evening_on and today_ita in schedule1_weekdays }}
          {%- elif trigger.id == 'schedule2_morning' -%}
            {{ schedule2_morning_on and today_ita in schedule2_weekdays }}
          {%- elif trigger.id == 'schedule2_evening' -%}
            {{ schedule2_evening_on and today_ita in schedule2_weekdays }}
          {%- elif trigger.id == 'schedule3_morning' -%}
            {{ schedule3_morning_on and today_ita in schedule3_weekdays }}
          {%- elif trigger.id == 'schedule3_evening' -%}
            {{ schedule3_evening_on and today_ita in schedule3_weekdays }}
          {%- elif trigger.id == 'schedule4_morning' -%}
            {{ schedule4_morning_on and today_ita in schedule4_weekdays }}
          {%- elif trigger.id == 'schedule4_evening' -%}
            {{ schedule4_evening_on and today_ita in schedule4_weekdays }}
          {%- else -%}
            false
          {%- endif -%}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# üöÄ SISTEMA DI ESECUZIONE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'main_morning' }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "üåÖ Dreame - Slot Principale Mattina"
                  message: >
                    Avvio pulizia mattutina:
                    - Modalit√†: {{ main_morning_preset }}
                    - Stanze: {{ main_morning_rooms if main_morning_rooms else 'Tutta casa' }}
                    - Orario: {{ main_morning_time }}
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ vacuum_ent }}"
            data:
              segments: >
                {% if main_morning_rooms %}
                  {{ main_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: "{{ main_morning_preset }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'main_evening' }}"
        sequence:
          - variables:
              already_cleaned: "{{ states(flag_ent) == 'on' }}"
              conditional_mode: "{{ main_evening_conditional }}"
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "üåô Dreame - Slot Principale Sera"
                  message: >
                    Controllo pulizia serale:
                    - Gi√† pulito oggi: {{ already_cleaned }}
                    - Logica: {{ conditional_mode }}
                    - Modalit√† primaria: {{ main_evening_preset }}
                    {% if conditional_mode == 'adapt_if_cleaned' %}
                    - Modalit√† alternativa: {{ main_evening_fallback_preset }}
                    {% endif %}
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: persistent_notification.create
                        data:
                          title: "‚è≠Ô∏è Dreame - Pulizia Saltata"
                          message: "Pulizia serale saltata: gi√† pulito oggi"
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: "{{ vacuum_ent }}"
                    data:
                      segments: >
                        {% if main_evening_fallback_rooms %}
                          {{ main_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: "{{ main_evening_fallback_preset }}"
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: "{{ vacuum_ent }}"
                data:
                  segments: >
                    {% if main_evening_rooms %}
                      {{ main_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: "{{ main_evening_preset }}"
              - service: input_boolean.turn_on
                target:
                  entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule1_morning' }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "üåÖ Dreame - Prima Schedulazione Mattina"
                  message: >
                    Avvio prima schedulazione mattutina:
                    - Modalit√†: {{ schedule1_morning_preset }}
                    - Stanze: {{ schedule1_morning_rooms if schedule1_morning_rooms else 'Tutta casa' }}
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ vacuum_ent }}"
            data:
              segments: >
                {% if schedule1_morning_rooms %}
                  {{ schedule1_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: "{{ schedule1_morning_preset }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule1_evening' }}"
        sequence:
          - variables:
              already_cleaned: "{{ states(flag_ent) == 'on' }}"
              conditional_mode: "{{ schedule1_evening_conditional }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: persistent_notification.create
                        data:
                          title: "‚è≠Ô∏è Dreame - Prima Schedulazione Saltata"
                          message: "Prima schedulazione serale saltata: gi√† pulito oggi"
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: "{{ vacuum_ent }}"
                    data:
                      segments: >
                        {% if schedule1_evening_fallback_rooms %}
                          {{ schedule1_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: "{{ schedule1_evening_fallback_preset }}"
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: "{{ vacuum_ent }}"
                data:
                  segments: >
                    {% if schedule1_evening_rooms %}
                      {{ schedule1_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: "{{ schedule1_evening_preset }}"
              - service: input_boolean.turn_on
                target:
                  entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule2_morning' }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "üåÖ Dreame - Seconda Schedulazione Mattina"
                  message: >
                    Avvio seconda schedulazione mattutina:
                    - Modalit√†: {{ schedule2_morning_preset }}
                    - Stanze: {{ schedule2_morning_rooms if schedule2_morning_rooms else 'Tutta casa' }}
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ vacuum_ent }}"
            data:
              segments: >
                {% if schedule2_morning_rooms %}
                  {{ schedule2_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: "{{ schedule2_morning_preset }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule2_evening' }}"
        sequence:
          - variables:
              already_cleaned: "{{ states(flag_ent) == 'on' }}"
              conditional_mode: "{{ schedule2_evening_conditional }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: persistent_notification.create
                        data:
                          title: "‚è≠Ô∏è Dreame - Seconda Schedulazione Saltata"
                          message: "Seconda schedulazione serale saltata: gi√† pulito oggi"
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: "{{ vacuum_ent }}"
                    data:
                      segments: >
                        {% if schedule2_evening_fallback_rooms %}
                          {{ schedule2_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: "{{ schedule2_evening_fallback_preset }}"
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: "{{ vacuum_ent }}"
                data:
                  segments: >
                    {% if schedule2_evening_rooms %}
                      {{ schedule2_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: "{{ schedule2_evening_preset }}"
              - service: input_boolean.turn_on
                target:
                  entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule3_morning' }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "üåÖ Dreame - Terza Schedulazione Mattina"
                  message: >
                    Avvio terza schedulazione mattutina:
                    - Modalit√†: {{ schedule3_morning_preset }}
                    - Stanze: {{ schedule3_morning_rooms if schedule3_morning_rooms else 'Tutta casa' }}
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ vacuum_ent }}"
            data:
              segments: >
                {% if schedule3_morning_rooms %}
                  {{ schedule3_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: "{{ schedule3_morning_preset }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule3_evening' }}"
        sequence:
          - variables:
              already_cleaned: "{{ states(flag_ent) == 'on' }}"
              conditional_mode: "{{ schedule3_evening_conditional }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: persistent_notification.create
                        data:
                          title: "‚è≠Ô∏è Dreame - Terza Schedulazione Saltata"
                          message: "Terza schedulazione serale saltata: gi√† pulito oggi"
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: "{{ vacuum_ent }}"
                    data:
                      segments: >
                        {% if schedule3_evening_fallback_rooms %}
                          {{ schedule3_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: "{{ schedule3_evening_fallback_preset }}"
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: "{{ vacuum_ent }}"
                data:
                  segments: >
                    {% if schedule3_evening_rooms %}
                      {{ schedule3_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: "{{ schedule3_evening_preset }}"
              - service: input_boolean.turn_on
                target:
                  entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule4_morning' }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: persistent_notification.create
                data:
                  title: "üåÖ Dreame - Quarta Schedulazione Mattina"
                  message: >
                    Avvio quarta schedulazione mattutina:
                    - Modalit√†: {{ schedule4_morning_preset }}
                    - Stanze: {{ schedule4_morning_rooms if schedule4_morning_rooms else 'Tutta casa' }}
          - service: dreame_vacuum.vacuum_clean_segment
            target:
              entity_id: "{{ vacuum_ent }}"
            data:
              segments: >
                {% if schedule4_morning_rooms %}
                  {{ schedule4_morning_rooms.split(',') | map('int') | list }}
                {% else %}
                  []
                {% endif %}
              cleaning_mode: "{{ schedule4_morning_preset }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ flag_ent }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'schedule4_evening' }}"
        sequence:
          - variables:
              already_cleaned: "{{ states(flag_ent) == 'on' }}"
              conditional_mode: "{{ schedule4_evening_conditional }}"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'skip_if_cleaned' and already_cleaned }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ debug_enabled }}"
                    then:
                      - service: persistent_notification.create
                        data:
                          title: "‚è≠Ô∏è Dreame - Quarta Schedulazione Saltata"
                          message: "Quarta schedulazione serale saltata: gi√† pulito oggi"
              - conditions:
                  - condition: template
                    value_template: "{{ conditional_mode == 'adapt_if_cleaned' and already_cleaned }}"
                sequence:
                  - service: dreame_vacuum.vacuum_clean_segment
                    target:
                      entity_id: "{{ vacuum_ent }}"
                    data:
                      segments: >
                        {% if schedule4_evening_fallback_rooms %}
                          {{ schedule4_evening_fallback_rooms.split(',') | map('int') | list }}
                        {% else %}
                          []
                        {% endif %}
                      cleaning_mode: "{{ schedule4_evening_fallback_preset }}"
            default:
              - service: dreame_vacuum.vacuum_clean_segment
                target:
                  entity_id: "{{ vacuum_ent }}"
                data:
                  segments: >
                    {% if schedule4_evening_rooms %}
                      {{ schedule4_evening_rooms.split(',') | map('int') | list }}
                    {% else %}
                      []
                    {% endif %}
                  cleaning_mode: "{{ schedule4_evening_preset }}"
              - service: input_boolean.turn_on
                target:
                  entity_id: "{{ flag_ent }}"

    default:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: persistent_notification.create
            data:
              title: "‚ùå Dreame - Errore"
              message: >
                Trigger non riconosciuto: {{ trigger.id }}
                Controlla la configurazione del blueprint.

mode: queued
max: 10
